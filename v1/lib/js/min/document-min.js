console.log('DOC');document.head.appendTag('link',{rel:'stylesheet',href:libroot+'/css/document.css'});Aim.add({Document:{createIndexListItem:function(el,Title,name){if(el.previousElementSibling)el.previousElementSibling.setAttribute('open',0);with(el.appendTag('li')){var elH=appendTag('h'+el.level,{onclick:Aim.Element.onclick}).appendTag('a',{innerText:Title,href:'#'+(name||Title)});elH.list=appendTag('ul',{level:el.level+1});with(Aim.Document.elBody){appendTag('a',{name:name||Title});elH.header=appendTag('h'+el.level,{innerText:Title});}}return elH;},show:function(){console.log('DOC SHOW N',this);with(this.elDoc=document.body.appendTag('div',{className:'row doc-body'})){with(this.elInfo=appendTag('div',{className:'col panel doc-content oa docinfo np'})){with(appendTag('div',{className:'row'})){appendTag('button',{innerText:'MS-Word',onclick:this.createWord.bind(this)});appendTag('button',{innerText:'Annuleren',onclick:function(){this.elDoc.parentElement.removeChild(this.elDoc);}.bind(this)});}}this.elBody=appendTag('div',{className:'col aco oa'}).appendTag('div',{className:'doc-content'});this.elIndex=appendTag('div',{className:'col panel doc-content oa docindex np'});}if(this.onload)this.onload();if(this.par)Aim.load(this.par);},createWord:function(html){console.log(html);var xhr=new XMLHttpRequest();xhr.open('GET','/sites/'+Aim.host+'/app/mht/template.mht',true);xhr.responseType='blob';xhr.onload=function(){var blob=new Blob([this.response],{type:'text/html'});var reader=new FileReader();reader.onload=function(){var item=items[get.id],aFilename=[],s=reader.result,today=aDate().toLocaleDateString();s=s.split(',')[1];var content=atob(s);content=content.replace(/=\r\n/g, '').replace(/=3D/g, '=');for(var fieldname in item.fields){var re=new RegExp('#'+fieldname+'#',"g");content=content.replace(re, item.fields[fieldname].value || '');if(item.fields[fieldname].kop===0&&item.fields[fieldname].value)aFilename.push(item.fields[fieldname].value);}if(item.elFilesView){content=content.replace('#files#', item.elFilesView.innerHTML);}var c=Document.elBody.getElementsByTagName('p');for(var i=0,e;e=c[i];i++)e.className='MsoNormal';var c=Document.elBody.getElementsByTagName('div');for(var i=0,e;e=c[i];i++)e.className='MsoNormal';var c=Document.elBody.getElementsByTagName('table');for(var i=0,e;e=c[i];i++)e.className='MsoNormalTable';var sIn=html||'';sIn=sIn.replace(/[\u00A0-\u2666]/g, function(c){return '&#'+c.charCodeAt(0)+';';});content=content.replace('##', sIn);content=content.replace(/#today#/g, today);content=content.replace(/#author#/g, Aim.accountName);content=content.replace(/=/g, '=3D');aFilename.push(Aim.accountName);aFilename.push(today);var s=btoa(content);function b64toBlob(b64Data,contentType,sliceSize){contentType=contentType||'';sliceSize=sliceSize||512;var byteCharacters=atob(b64Data);var byteArrays=[];for(var offset=0;offset<byteCharacters.length;offset+=sliceSize){var slice=byteCharacters.slice(offset,offset+sliceSize);var byteNumbers=new Array(slice.length);for(var i=0;i<slice.length;i++){byteNumbers[i]=slice.charCodeAt(i);}var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray);}var blob=new Blob(byteArrays,{type:contentType});return blob;}var blob=b64toBlob(s,'text/html');url=window.URL.createObjectURL(blob);var link=document.createElement('a');link.href=url;link.setAttribute('download',aFilename.join(' ')+'.mht');link.click();window.URL.revokeObjectURL(url);}reader.readAsDataURL(blob);}xhr.send();},createIndex:function(){var html=this.elBody.innerHTML;this.elIndex=this.el.appendTag('div',{className:"col atv noselect np",}).appendTag('ul',{className:"liopen",}).appendTag('li').appendTag('ul');OM.printdiv=Document.elBody=appendTag('div',{className:"col aco oa doc",innerHTML:html,onscroll:function(){var c=Document.elIndex.getElementsByTagName('LI');var elFocus=null,elPrev=null;for(var i=0,e;e=c[i];i++){if(e.h.offsetTop-25>=Document.elBody.scrollTop)elFocus=elFocus||elPrev||e;elPrev=e;if(e.getAttribute('open')!=undefined)e.setAttribute('open',0);e.removeAttribute('focus');}elFocus=elFocus||elPrev||e;if(!elFocus)return;elFocus.setAttribute('focus',1);while(elFocus.h){if(elFocus.getAttribute('open')!=undefined)elFocus.setAttribute('open',1);elFocus=elFocus.parentElement.parentElement;}}});var c=Document.elBody.getElementsByTagName('H1');var elFirstChapter=null;var ul=[null,Document.elIndex];if(!c[0])return;var c=c[0].parentElement.children;console.log(c);for(var i=0,e;e=c[i];i++){if(['H1','H2','H3'].indexOf(e.tagName)!=-1){if(ul[Number(e.tagName[1])])ul[Number(e.tagName[1])].parentElement.setAttribute('open',1);var eName=e.previousElementSibling||{};with(e.li=ul[e.tagName[1]].appendTag('li',{h:e})){with(appendTag('div',{className:'row'})){appendTag('open',{onclick:function(event){this.parentElement.parentElement.setAttribute('open',this.parentElement.parentElement.getAttribute('open')^ 1);}});appendTag('a',{href:'#'+(eName.id||e.name),innerText:e.innerText,onclick:function(event){event.stopPropagation();}});}ul[Number(e.tagName[1])+1]=appendTag('ul');}}}},sbs:function(event){console.log('SBS',event.par.src,event.data,this.el);this.data=event.data;with(this.elBody){(writeItem=function(item,i,rows){var value,name=item.id;appendTag('a',{name:name});appendTag('h'+rows.level,{innerText:item.title});(item.elIndexTitle=(item.elIndexLI=rows.elIndexUL.appendTag('li')).appendTag('h'+rows.level,{onclick:Aim.Element.onclick})).appendTag('a',{innerText:item.title,href:'#'+name,});with(appendTag('table',{className:'properties'})){for(var name in item.attributes)if(value=item.getValue(name,true))with(appendTag('tr')){appendTag('th',{innerText:name});if(item.attributes[name].itemID)appendTag('td').appendTag('a',{innerText:value,href:'#'+item.attributes[name].itemID});else appendTag('td',{innerText:value});}}if(item.children){item.elIndexTitle.setAttribute('open',0);item.children.level=rows.level+1;item.children.elIndexUL=item.elIndexLI.appendTag('ul');item.children.forEach(writeItem.bind(this));}})(this.item,0,{level:0,elIndexUL:this.elIndex.appendTag('ul')});}}},});