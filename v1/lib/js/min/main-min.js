Aim=window.Aim||{version:'v1',config:{wss:{"hostname":"aliconnect.nl","protocol":"wss","port":444,"url":"wss://aliconnect.nl:444"},origin:"https://aliconnect.nl"},host:"aliconnect",hostID:2,client:{user:{id:1}}};apiorigin=Aim.httpHost=='localhost'&&Aim.local=='api'?"http://localhost":Aim.config.origin;libroot=apiorigin+"/aim/"+Aim.version+"/lib";apiroot=apiorigin+"/"+Aim.host+"/"+Aim.version+"/api/";if(!('console' in window))console={log:function(){}};if(!('Object' in window))Object={};if(!('assign' in Object))Object.assign=function(dest){for(var i=1,source;source=arguments[i];i++)for(var name in source)dest[name]=source[name];return dest;}var day=["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"];var days=["Zo","Ma","Di","Wo","Do","Vr","Za"];var month=["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"];var today=vandaag=new Date();vandaag.setHours(0,0,0,0);Aim=aliconnect=Object.assign(Aim,{init:[],root:(document.location.hostname=='localhost'&&Aim.local=='api'?'':Aim.config.origin)+'/aim/'+Aim.version,api:Api=api={fav:[],item:[],onload:function(row,i,rows){if(!row||!row.id)return row;var item=api.item[row.id]=api.item[row.id]||Object.create(api.definitions.item,api.definitions.itemproperties);if(!item.schema&&row.schema){(api[item.schema=row.schema]=api[row.schema]||[])[row.id]=item;item.assignschema();}item.values=item.values||row.values;item.loading=true;Object.assign(item,row);item.loading=false;item.filterfields=item.filterfields||{};if(rows)rows[i]=item;item.items=item.children=item.children||[];if(item.master){if(item.master.children.indexOf(item)==-1){item.master.children.push(item);}if(!(item.schema in item.master))Object.defineProperty(item.master,item.schema,{get:function(className){var a=[];this.children.forEach(function(child){if(child.schema==className)a.push(child);});a.sort(App.sort.idx);return a;}.bind(item.master,item.schema),});if(item.typical&&!(item.typical in item.master))Object.defineProperty(item.master,item.typical,{get:function(className){var a=[];this.children.forEach(function(child){if(child.schema==className)a.push(child);});a.sort(App.sort.idx);return a;}.bind(item.master,item.typical),});}if(rows&&rows.get&&rows.get.select=='*')item.selectall=true;item.refresh();return item;},definitions:definitions={item:{id:null,assignschema:function(){Aim.merge(this,api.definitions.item,api.definitions[this.schema]||api.definitions[this.schema.toLowerCase()],this.typical&&api.definitions[this.typical]?api.definitions[this.typical]:null,this.masterID==this.srcID&&api.definitions[this.name]?api.definitions[this.name]:null);this.attributes=this.properties=this.properties||this.attributes;for(var attributeName in this.attributes){this.attributes[attributeName].name=attributeName;if(!(attributeName in this))Object.defineProperty(this,attributeName,{get:this.getAttributeValue.bind(this,attributeName),set:this.setAttribute.bind(this,attributeName),});}this.filterfields=this.filterfields||this.getFilterfields()||{};},set:function(values,onload){Aim.load({put:{value:[{schema:this.schema,id:this.detailID||this.id,values:values}]},item:this,onload:onload||function(){console.log('SET DONE',this.src,this.put,this.data);}});this.refresh();this.show();},getrel:function(name,root){if(!this[name])return;if('title' in this[name])return this[name].getrel(name,root);this[name].title='';Aim.load({name:name,root:root,get:{schema:'item',id:this[name].id,select:Aim.config.coltree.select},onload:function(event){var item=api.item[this.get.id];this.root.write();item.getrel(this.name,this.root);}});},getKopText:function(kop,name){if(!this.selectall)return name?this[name]:"";var a=[],value;for(var attributeName in this.attributes)if(this.attributes[attributeName].kop==kop&&(value=this.getAttributeValue(attributeName,true))){a.push((this.attributes[attributeName].prefix||"")+value+(this.attributes[attributeName].unit||"")+(this.attributes[attributeName].postfix||""));}var retValue=a.join(" ");return retValue||"";},getFilterfields:function(){if(!this.values)return;var filterfields={};for(var attributeName in this.attributes){if(this.attributes[attributeName].filter){var value=this.getAttribute(attributeName);if(value)filterfields[attributeName]=this.getAttributeValue(attributeName);}}filterfields.Schema=this.schema;if(this.typical)filterfields.Typical=this.typical;if(this.state)filterfields.State=this.state;delete filterfields.state;return filterfields;},getAttribute:function(attributeName){var prop={modifiedDT:{get:function(attributeName){return this.values&&this.values[attributeName]?this.values[attributeName].modifiedDT:null}.bind(this,attributeName),},value:{get:this.getAttributeValue.bind(this,attributeName),},itemID:{get:function(attributeName){return this.values&&this.values[attributeName]?this.values[attributeName].itemID:null}.bind(this,attributeName),},displayvalue:{get:this.getAttributeValue.bind(this,attributeName,true),},defaultvalue:{get:this.getAttributeDefault.bind(this,attributeName),},mastervalue:{get:this.getAttributeMaster.bind(this,attributeName),},className:{get:function(attributeName){var className=attributeName;if(this.values&&this.values[attributeName]){if(this.values[attributeName]&&this.values[attributeName].valueSource)className+=this.values[attributeName].valueSource !=this.values[attributeName].value?' override':' default';if(this.lastvisitDT&&this.values[attributeName].modifiedDT&&new Date(this.values[attributeName].modifiedDT).valueOf()>new Date(this.lastvisitDT).valueOf())className+=' modified';}return className;}.bind(this,attributeName),},},prop=Object.create(this.attributes&&this.attributes[attributeName]?this.attributes[attributeName]:{},prop);prop.type=prop.type||(prop.schema?'selectitem':prop.options?'select':'text');prop.placeholder=prop.title||prop.placeholder||name;prop.item=this;return Object.assign(prop,prop.stereotype,Aim.attribute.type.text,Aim.attribute.type[prop.type]);},getAttributeValue:function(attributeName,view){var value=null;if(this.values&&(attributeName in this.values)&&this.values[attributeName]){value=this.values[attributeName].itemID&&api.items[this.values[attributeName].itemID]&&"title" in api.items[this.values[attributeName].itemID]?api.items[this.values[attributeName].itemID].title:(typeof this.values[attributeName]=="object"?this.values[attributeName].title||this.values[attributeName].value:this.values[attributeName]);}if(this.attributes&&(attributeName in this.attributes)){var attribute=this.attributes[attributeName];if(attribute.idname&&!attribute.schema&&attribute.idname !=attributeName){value=this[attribute.idname];}if(attribute.calc)value=attribute.calc.call(this,value);if(view){if(attribute.options&&(value in attribute.options))value=attribute.options[value].title||attribute.options[value];if(attribute.type=='date')value=aDate(value).toDateText(1);if(attributeName=="Value"&&this.Enum)value=this.Enum.split(",")[value];}if(attribute.display)value=attribute.display(value);}else if(attributeName in this)value=Aim.Object.getAttribute(this,attributeName);return value;},getAttributeDefault:function(name,view,i){if(i>5)return;return this.source?this.source.getAttributeValue(name,view)||this.source.getAttributeDefault(name,view,(i||0)+1):'';},getAttributeMaster:function(name,view){return '';},refreshAttribute:function(attributeName){},setAttribute:function(attributeName,value,refresh){var currentvalue=this.getAttributeValue(attributeName),kopName=['title','subject','summary'],attribute=this.attributes?this.attributes[attributeName]:{},item={id:this.id,schema:this.schema,typical:this.typical,values:{}};this.values=this.values||{};value=String(value==undefined?"":value).trim();if(currentvalue==value)return;item.values[attributeName]=this.values[attributeName]=this.values[attributeName]||{};this.values[attributeName].value=this.values[attributeName].value=value;if(attribute){if('schema' in attribute)item.values[attributeName].schema=attribute.schema;if('idname' in attribute){item.values[attributeName].idname=attribute.idname;this[attribute.idname]=value;}if('filter' in attribute)item.filterfields=this.filterfields=this.getFilterfields();if('kop' in attribute)item.values[kopName[attribute.kop]]={value:this[kopName[attribute.kop]]=this.getKopText(attribute.kop)};if(attribute.onchange)attribute.onchange.call(this);}if(!value)delete item.values[attributeName].itemID;if(this.loading)return;if(value&&['title','subject','summary'].indexOf(attributeName)!=-1)this[attributeName]=value;this.refresh();if(refresh)return;this.setAttributeCount=(this.setAttributeCount||0)+1;Aim.setAttributeBuf=Aim.setAttributeBuf||[];Aim.setAttributeBuf.push(item);clearTimeout(Aim.setAttributeTO);Aim.setAttributeTO=setTimeout(function(){console.log('SetAttributeTO',Aim.setAttributeBuf);Aim.load({put:{value:Aim.setAttributeBuf},onload:function(event){Aim.wss.send({value:this.put.value});}});var ids={};Aim.setAttributeBuf.forEach(function(row){ids[row.id]=api.item[row.id];});for(var id in ids)api.item[id].refreshAttributes();Aim.setAttributeBuf=[];},10);},getChildren:function(){return this.detailID?this.detail.children:this.children;},refreshAttributes:function(){var s=new Date();var attributes={title:this.title,subject:this.subject,summary:this.summary};if(this.values)for(var attributeName in this.values)if(!attributes[attributeName]){var attribute=this.getAttribute(attributeName);attributes[attributeName]=attribute.displayvalue;}for(var i=0,e,c=document.getElementsByClassName(this.id);e=c[i];i++){for(var attributeName in attributes){var displayvalue=attributes[attributeName],value=this.getAttribute(attributeName).value;if(e.hasAttribute(attributeName)&&e.getAttribute(attributeName)!=value){e.setAttribute(attributeName,value);e.setAttribute('modified',new Date().toLocaleString());}for(var i1=0,e1,c1=e.getElementsByClassName(attributeName);e1=c1[i1];i1++){if(e1.hasAttribute('checked')){if(value)e1.setAttribute('checked','');else e1.removeAttribute('checked');e1.setAttribute('modified',new Date().toLocaleString());}else if("value" in e1){if(e1.value !=value){e1.value=value;e1.setAttribute('modified',new Date().toLocaleString());}}else if(e1.hasAttribute('value')){if(e1.getAttribute('value')!=value){e1.setAttribute('value',value);e1.setAttribute('modified',new Date().toLocaleString());}}else if(e1.innerHTML !=displayvalue){e1.innerHTML=displayvalue||"";e1.setAttribute('modified',new Date().toLocaleString());}}}}},refresh:function(row){if(this.finishDT)this.flag='done';else if(this.endDT){this.daysLeft=Math.round((new Date(this.endDT)-vandaag)||1000||60||60||24);this.flag=this.daysLeft>14?'afternextweek':this.daysLeft>7?'nextweek':this.daysLeft>1?'thisweek':this.daysLeft>0?'tomorow':this.daysLeft==0?'today':'overdate';}else this.flag='';var deadline={'done':'Gereed','overdate':'Te laat','today':'Vandaag','tomorow':'Morgen','thisweek':'Deze week','nextweek':'Volgende week','afternextweek':'Later','':'Geen'}this.filterfields=this.filterfields||{};this.filterfields.Deadline=deadline[this.flag];this.filterfields.Bijlagen=this.hasAttach?'Ja':'Nee';this.filterfields.Status=this.state;this.filterfields.Schema=this.schema;if(!this.external)['title','subject','summary'].forEach(function(name,i){var value=this.getKopText(i,name)||"";if(value&&(this[name]||'')!=value){this.setAttribute(name,value);}}.bind(this));if(this.elLvLi)this.elLvLi.rewrite();if(this.createTreenode)this.createTreenode();for(var i=0,c=document.getElementsByClassName('checkvisible'),e;e=c[i];i++)if(e.checkvisible)e.setAttribute('visible',e.checkvisible());}},itemproperties:{master:{get:function(){return this.masterID?Aim.get({id:this.masterID}):null}},parent:{get:function(){return this.master}},index:{get:function(){return this.master?this.master.children.indexOf(this):-1}},source:{get:function(){return this.srcID?Aim.get({id:this.srcID}):null}},detail:{get:function(){return this.detailID?Aim.get({id:this.detailID}):{}}},isClass:{get:function(){return Number(this.masterID)==Number(this.srcID);}},classTag:{get:function(){return(this.source&&this.source.tag?this.source.tag:'')+(this.tag||'');}},classItemName:{get:function(){return(this.source&&this.source.name?this.source.name:'')+(this.name||'');}},hasAttach:{get:function(){return this.files&&this.files&&this.files.length}},hasImage:{get:function(){return this.hasAttach&&App.file.oisImg(this.files[0])}},iconsrc:{get:function(){if(!this.files||!this.files.length)return '';for(var i=0,f;f=this.files[i];i++)if(App.file.oisImg(f))break;return f?f.src:'';}},fav:{get:function(){return Aim.api.fav.indexOf(this.detailID||this.id)!=-1;},set:function(value){var fav=this.fav;if(value&&!fav)Aim.api.fav.unshift(this.detailID||this.id);else if(!value&&fav)Aim.api.fav.splice(Aim.api.fav.indexOf(this.detailID||this.id),1);Aim.load({api:'fav',get:{id:this.detailID||this.id},post:{fav:value}});for(var i=0,e,c=document.getElementsByClassName(this.detailID||this.id);e=c[i];i++)if(e.rewrite)e.rewrite();}},stateColor:{get:function(){return this.state&&this.attributes&&'state' in this.attributes&&'options' in this.attributes.state&&this.attributes.state.options[this.state]?this.attributes.state.options[this.state].color:null;return this.masterID?api.item[this.masterID]||Aim.get({id:this.masterID}):{}}},fullTag:{get:function(){var text=[this.classTag],item=this.master;while(item){if(item.tag)text.unshift(item.classTag);item=item.master;}return text.join('.');}},fullName:{get:function(){var text=[this.classItemName],item=this.master;while(item){if(item.tag)text.unshift(item.classItemName);item=item.master;}return text.join('_');}},titleText:{get:function(){return this.getKopText(0,'title')||String(this.detail.subject||'').trim();}},subjectText:{get:function(){return this.getKopText(1,'subject')||String(this.detail.subject||'').trim();}},summaryText:{get:function(){return this.getKopText(2,'summary')||String(this.detail.summary||'').trim();}},tooltipText:{get:function(){var s='';var fnames='keyname,name,fullName,tag,fullTag'.split(',');for(var i=0,name;name=fnames[i];i++)if(this[name])s+=name+':'+this.getAttribute(name)+"\r\n";return s;}},typicalIdx:{get:function(){var idx=0;for(var i=0,item;item=this.master.children[i];i++){if('selected' in item&&item.selected==0)continue;if(item.srcID==this.srcID)idx++;if(item==this)return idx;}}},modified:{get:function(){return !this.modifiedDT?"":(!this.lastvisitDT?"new":(new Date(this.modifiedDT).valueOf()>new Date(this.lastvisitDT).valueOf()?"modified":""));},},},},item:items=[],find:function(classID){for(var schemaname in api.definitions)if(api.definitions[schemaname]&&api.definitions[schemaname].classID==classID)return schemaname;},getTitleAttributeName:function(schema){if(typeof schema=='string')schema=Aim.api.definitions[schema];schema.attributes=schema.attributes||schema.properties;for(var attributeName in schema.attributes)if(schema.attributes[attributeName].default)break;if(!attributeName)for(var attributeName in schema.attributes)if(schema.attributes[attributeName].kop===0)break;return attributeName;},mergeinto:function(newID,oldID){console.log('SAMENVOEGEN');Aim.load({api:'item/'+newID+'/itemMerge',get:{oldID:oldID},onload:this.onload||function(){console.log(this.data);}});}},Element:{onclick:function(){if(this.hasAttribute('open')){this.setAttribute('open',this.getAttribute('open')^ 1);if(this.getAttribute('open')!=1)return;if(this.onopen&&!this.loaded)this.loaded=this.onopen();var eTop=this;while(eTop){if(eTop.open1){var e=this;while(e){if(e.open1)return;for(var i=0,c=e.parentElement.children,ec;ec=c[i];i++)if(ec.hasAttribute('open')&&ec !=e&&ec !=e.previousElementSibling){ec.setAttribute('open',0);console.log(e,ec,ec.hasAttribute('open'));}e=e.parentElement;}}eTop=eTop.parentElement;}}if(this.itemID){var item=api.items[this.itemID];if(item)document.location.href='#'+item.schema+'/'+item.id+'?select=*';return false}else if(this.set){Aim.URL.set(this.set);return false}else if(this.infoID){event.stopPropagation();Aim.get({id:this.infoID}).showinfo();if(Aim.Element.PopupCard){Aim.Element.PopupCard.parentElement.removeChild(Aim.Element.PopupCard);Aim.Element.PopupCard=null;}return false}else if(this.colName){document.body.setAttribute('ca',this.colName);OM.colActive=this;OM.elColActive=this;Aim.printSource=this;}else if(this.elClose)this.elClose.parentElement.removeChild(this.elClose);else if(this.get)Aim.URL.set(typeof this.get=='function'?this.get():this.get);},onchange:function(event){if(this.item&&this.name){this.item.values=this.item.values||{};var attributeValue=this.item.values[this.name]=this.item.values[this.name]||{};if(this.itemID)attributeValue.itemID=this.itemID;if(this.hasAttribute("contenteditable"))this.value=this.innerHTML !="<p><br></p>"?this.innerHTML:"";if(this.item.setAttribute)this.item.setAttribute(this.name,this.value);}},setAttribute:function(e,value){if('value' in e)e.value=value;else if(e.hasAttribute('value'))e.setAttribute('value',value);else if(e.innerHTML[0] !='<')e.innerText=value;},Pulldown:{loadmsg:'Get items of class',autocomplete:'off',onblur1:function(){if(this.el&&this.el.parentElement)this.el.parentElement.removeChild(this.el);if(this.onchange)this.onchange();},onfocus:function(){this.el=this.parentElement.appendTag('div',{className:'dropdown'});this.prevValue=this.value.trim().toLowerCase();},onselectdone:function(event){clearTimeout(OM.toKeyup);clearTimeout(OM.toLoad);this.id=this.el.elSelected.id;this.prevValue=String(this.value=this.el.elSelected.value).trim().toLowerCase();this.el.innerText='';if(this.onitemselect)this.onitemselect();Aim.Element.onchange.call(this,event);this.select();},showpd:function(rows){this.rows=rows||this.rows;with(this.el){innerText='';for(var i=0,row;row=this.rows[i];i++){with(appendTag('div',{id:row.id,elInp:this,value:row.title||row.name})){appendTag('div',{innerText:row.title||row.name});appendTag('small',{innerText:row.subject||''});appendTag('small',{innerText:row.summary||''});onclick=function(event){event.preventDefault();event.stopPropagation();this.elInp.el.elSelected=this;this.elInp.onselectdone();};}}this.el.elSelected=this.el.firstChild;if(this.el.elSelected)this.el.elSelected.setAttribute('selected','');}},findlist:function(rows){rows=api[this.schema];console.log('FINDLIST',rows);this.words=this.value.split(' ');this.rows=[];if(rows)rows.forEach(function(row,itemID){var title=row.title.toLowerCase();for(var i=0,word;word=this.words[i];i++)if(title.indexOf(word)==-1)return;this.rows.push(row);},this);this.showpd();},load:function(){console.log('FIND LOAD>>>>>>',this.value,this.schema);Aim.load({el:this,activeElement:document.activeElement,get:Object.assign(this.get||{},{schema:this.schema,select:'title,subject,summary',q:this.value.trim().toLowerCase(),search:'name,keyname,title,subject,summary',filter:this.selectfilter||'',top:20},this.get||{}),onload:function(){this.el.showpd(this.data.value);}});},onkeyup:function(){if(!this.value)this.el.innerText='';this.itemID=null;if(this.prevValue==this.value.trim().toLowerCase())return;this.prevValue=this.value.trim().toLowerCase();if(this.value){OM.toKeyup=setTimeout(function(){this.rows=[];var words=this.value.split(' ');if(api[this.schema])for(var itemID in api[this.schema]){var row=api[this.schema][itemID];var title=String(row.title).toLowerCase();for(var i=0,notfound=true,word;(word=words[i])&&notfound;i++){notfound=title.indexOf(word.toLowerCase())==-1};if(!notfound)this.rows.push(row);};console.log('FINDLIST>>>>>>>',this.rows,this.rows.length);if(this.rows.length)return this.showpd(this.rows);clearTimeout(OM.toLoad);this.load();}.bind(this),500);OM.toLoad=setTimeout(this.load.bind(this),2000);}},onkeydown:function(event){clearTimeout(OM.toKeyup);clearTimeout(OM.toLoad);this.itemID=null;var key=event.key;if(this.el.innerText !=''&&key){var key=key.replace('Arrow', '').replace('Escape', 'Esc');if(key=='Up'){this.el.elSelected.removeAttribute('selected');if(this.el.elSelected.previousElementSibling)this.el.elSelected=this.el.elSelected.previousElementSibling;this.el.elSelected.setAttribute('selected','');Aim.Element.scrollIntoView(this.el.elSelected);console.log('UP');event.preventDefault();return;}else if(key=='Down'){this.el.elSelected.removeAttribute('selected');if(this.el.elSelected.nextElementSibling)this.el.elSelected=this.el.elSelected.nextElementSibling;this.el.elSelected.setAttribute('selected','');Aim.Element.scrollIntoView(this.el.elSelected);console.log('DN');event.preventDefault();return;}else if(key=='Esc'){this.el.innerText='';event.stopPropagation();event.preventDefault();return;}else if(key=='Enter'){event.stopPropagation();event.preventDefault();this.onselectdone();return false;}}},},popup:function(el){if(!el.itemID)return;el.showcard=function(){if(Aim.Element.PopupCard){Aim.Element.PopupCard.parentElement.removeChild(Aim.Element.PopupCard);Aim.Element.PopupCard=null;}if(Aim.Element.hover)with(Aim.Element.PopupCard=Aim.Element.hover.appendTag('div',{className:'pucard shadow col'})){var rect=Aim.Element.hover.getBoundingClientRect();style.top=(rect.top+rect.height)+'px';with(appendTag('div',{className:'aco point',infoID:this.id,onclick:Aim.Element.onclick})){appendTag('div',{className:'kop0',innerText:this.title});appendTag('div',{className:'kop1',innerText:this.subject});appendTag('div',{className:'kop2',innerText:this.summary});}with(appendTag('div',{className:'row btnbar'})){if(this.properties)Object.entries(this.properties).forEach(function(aObject,i){var attributeName=aObject.shift(),field=aObject.shift();if(field.type=='tel'&&field.value)appendTag('a',{className:'abtn icn phone',title:field.value,href:'tel:'+field.value});});}}}el.href='#?'+Aim.URL.stringify({schema:el.schema||'item',id:el.itemID});el.onmouseenter=Aim.Element.onmouseenter;el.onmouseleave=Aim.Element.onmouseleave;return el;},onmouseenter:function(){if(this.showcard){Aim.Element.hover=this;if(api.items[this.itemID]&&api.items[this.itemID].title)this.showcard.call(api.items[this.itemID]);else Aim.load({api:'item',get:{id:this.itemID},showcard:this.showcard,onload:function(){this.showcard.call(api.items[this.data.id])}});}},onmouseleave:function(){if(this.showcard){Aim.Element.hover=null;if(Aim.Element.PopupCard){Aim.Element.PopupCard.parentElement.removeChild(Aim.Element.PopupCard);Aim.Element.PopupCard=null;}}},hasParent:function(el,elPar){while(el&&el !=elPar)el=el.parentElement;return el;},open:function(){if(this.getAttribute('open')!=undefined)this.setAttribute('open',1);},close:function(){if(this.getAttribute('open')!=undefined)this.setAttribute('open',0);},setOpen:function(el){el.setAttribute('open',Aim.foldersOpen&&Aim.foldersOpen.indexOf(el.label)!=-1?1:0);el.onclick=function(){this.setAttribute('open',this.getAttribute('open')^ 1);if(Number(this.getAttribute('open')))Aim.foldersOpen.unshift(this.label);else if(Aim.foldersOpen)Aim.foldersOpen.splice(Aim.foldersOpen.indexOf(this.label),1);document.cookie='foldersOpen='+Aim.foldersOpen.join(',');};},scrollIntoView:function(el,cont){if(el)el.scrollIntoView({block:"nearest",inline:"nearest"});},},URL:{his:function(get,hisaction){var search=Aim.URL.par(document.location.search.substr(1));for(var name in get){if(name&&(search[name]=get[name])&&name !='id'&&name !='title')document.body.setAttribute(name,search[name]=get[name]);else document.body.removeAttribute(name);if(!search[name])delete search[name];if(!get[name])delete get[name];}search='?'+Aim.URL.stringify(window.get=search);if(window.get.q&&document.getElementById('q'))document.getElementById('q').value=window.get.q;if(hisaction==2)return;if(hisaction==1){if(window.history.replaceState)window.history.replaceState('page', 'PAGINA', search);}else if(window.history.pushState)window.history.pushState('page','PAGINA',search);},setitem:function(item){this.set({schema:item.schema,id:item.id});},set:function(get,hisaction){if(get.folder&&(!get.q||get.q=='*'))get=Object.assign({select:"",title:"",child:"",q:"",filter:"",src:'',reload:'',master:'',users:'',refby:'',link:''},get);if((get.folder||get.q)&&Aim.collist)Aim.collist.set(Object.assign(get,{schema:'',id:''}));else if(get.schema&&get.id){if(!get.reload&&(item=Aim.get({schema:get.schema,id:get.id})).loaded)Aim.createElementPage.call({get:get={schema:get.schema,id:get.id},data:{schema:item.schema,value:[item]}});else Aim.load({get:get={schema:get.schema,id:get.id,select:'*'},onload:Aim.createElementPage});}this.his(get,hisaction);},exec:function(url,hisaction){var path=url.split('?'),get=path.pop(),path=path.pop(),item;if(get.indexOf('=')!=-1){Aim.URL.set(Aim.URL.par(get),hisaction);return false;}if(path){for(var i=0,obj=window,parent,ref=path.split(/\/|\./);obj[ref[i]];i++){parent=obj;obj=obj[ref[i]];}if(obj&&typeof obj==='function'){obj.apply(parent,get?get.split('&'):[]);return false;}}var c=document.getElementsByName(url),e=c[0];if(e)return e.scrollIntoView();},byref:function(ref){for(var i=0,obj=window,ref=ref.split(/\/|\./);obj[ref[i]];i++)obj=obj[ref[i]];return obj;},objbyref:function(ref,e){var ref=ref.split('#').pop().split('?'),path=ref.shift().split(/\/|\./),e=e||window,p,name;while((name=path.shift())&&e){p=e;e=e[name];}var pars={},search=ref.shift();if(search)search.split('&').forEach(function(par){par=par.split('=');pars[par.shift()]=par.shift()});return{e:e,pars:pars,p:p};},stringify:function(get){var a=[];for(var name in get)a.push(name+'='+get[name]);return a.join('&');},parse:function(s){s=s||document.location.href;try{s=decodeURI(s);}catch(err){};var par={};if(s.indexOf('?')==-1&&s.indexOf('#')==-1)return par;if(s.indexOf('?')==-1&&s.indexOf('#')!=-1)var a=[s.split('#')[1]];else var a=s.split('?')[1].split('#');for(var i=0,p;p=a[i];i++){var ap=p.split("&");for(var ip=0;ip<ap.length;ip++){var pair=ap[ip].split("=");var key=pair.shift();var val=pair.join('=');par[key]=(isNaN(val))?val:Number(val);}}return par;},par:function(ref){var pars={};ref.split('&').forEach(function(par){if(!par)return;par=par.split('=');pars[par.shift()]=par.join('=');});return pars;},},Object:{getAttribute:function(obj,name){if(!obj||!name||!(name in obj)||!obj[name])return "";if(typeof obj[name] !='object')return obj[name];if('value' in obj[name])return value=obj[name].value;else if('title' in obj[name])var value=obj[name].title;else value=value||obj[name];if('calc' in obj[name])var value=obj[name].calc(value||'');return value;},stringify:function(par){var s='';for(var name in par)s+=name+':'+par[name].join(',')+';';return s;},parse:function(s){var a1=decodeURIComponent(s).split(';');var par={};for(var i=0,a;a=a1[i];i++){var a2=a.split(':');par[a2[0]]=a2[1].split(',');}return par;},toArray:function(o){var a=[];for(var id in o){o[id].id=o[id].id||id;a.push(o[id]);}return a;},toArray1:function(o){var a=[];for(var id in o){var obj=items.item.call(o[id]);a.push(obj);}return a;},toArrayTitle:function(o,a){for(var title in o){var row=o[title];row.title=row.title=row.name=title;a.push(row);if(row.items)Aim.Object.toArrayTitle(row.items,row.children=[]);}},find:function(objlist,fn,t){for(var name in objlist)if(fn.call(t,objlist[name]))return name;},findFieldValue:function(objlist,attributeName,value){for(var name in objlist){if(objlist[name]&&objlist[name][attributeName]==value)return name;}},},Aliconnector:{},Document:{create:function(data){console.log('DOC CREATE');if(!(data instanceof Event))Object.assign(this,data);Aim.libraryShow.call(this,[libroot+'/js/document.js']);},},Upload:{create:function(data){if(!(data instanceof Event))Object.assign(this,data);Aim.libraryShow.call(this,[libroot+'/js/xlsx.js',libroot+'/js/jszip.js',libroot+'/js/upload.js']);},},Charts:Charts={create:function(data){if(!(data instanceof Event))Object.assign(this,data);Aim.libraryShow.call(this,[apiorigin+'/inc/js/amcharts4/dist/script/core.js',apiorigin+'/inc/js/amcharts4/dist/script/charts.js',apiorigin+'/inc/js/amcharts4/dist/script/themes/animated.js',libroot+'/js/charts.js']);},},Charts3:Charts3={create:function(data){Aim.libraryShow.call(this,[apiorigin+'/inc/js/amcharts3/amcharts/amcharts.js',apiorigin+'/inc/js/amcharts3/amcharts/serial.js',apiorigin+'/inc/js/amcharts3/amcharts/pie.js',]);},},Go:Go={create:function(data){if(!(data instanceof Event))Object.assign(this,data);Aim.libraryShow.call(this,[apiorigin+'/inc/js/go1/go.js',libroot+'/js/go.js']);}},Calendar:Calendar={create:function(el,data){if(!(el instanceof Event))Object.assign(this,{el:el,data:data});Aim.libraryShow.call(this,[libroot+'/js/calendar.js']);}},Ganth:Ganth={create:function(el,data){console.log('Ganth Create');if(!(el instanceof Event))Object.assign(this,{el:el,rows:data});Aim.libraryShow.call(this,[libroot+'/js/ganth.js']);},},Three:Three={create:function(el,id){if(!(el instanceof Event)){this.el=el;this.id=id;}console.log('THREE');Aim.libraryShow.call(this,[apiorigin+'/inc/js/three/build/three.js',apiorigin+'/inc/js/three/examples/js/libs/stats.min.js',apiorigin+'/inc/js/three/examples/js/controls/OrbitControls.js',apiorigin+'/inc/js/three/examples/js/renderers/Projector.js',libroot+'/js/three.js']);},},Notification:{create:function(data){Object.assign(this,data);with(popupmessage.el=popupmessage.appendTag('li',{className:'row'})){appendTag('button',{className:"abtn icn close abs",onclick:function(){popupmessage.removeChild(this)}.bind(popupmessage.el)});if(data.options.icon)appendTag('img',{src:data.options.icon});with(appendTag('div',{className:'aco'})){appendTag('header',{innerText:data.title});appendTag('div',{innerText:data.options.body});}}if(!("Notification" in window))return console.log("This browser does not support desktop notification");if(Notification.permission==="granted"){var notification=new Notification(this.title,this.options);notification.onclick=function(event){event.preventDefault();console.log('Notify Click Options',this);window.focus();if(this.url)document.location.href=this.url;}.bind(this.options);notification.onerror=function(event){console.log('Notify ERROR',this,event);}.bind(this.options);notification.onclose=function(event){console.log('Notify CLOSE',this,event);}.bind(this.options);notification.onshow=function(event){console.log('Notify SHOW',this,event);}.bind(this.options);}else if(Notification.permission !=='denied'||Notification.permission==="default"){Notification.requestPermission(function(permission){this.permission=permission;if(permission==="granted"){var notification=new Notification(this.title,this.options);}}.bind(this));}},},Alert:{appendAlert:function(alert){if(!document.getElementById('alertpanel'))return;if(!Aim.elAlertrow){with(document.getElementById('alertpanel')){Aim.elAlertsum=document.getElementById('alertsum')||appendTag('div',{className:'col',id:'alertsum'});Aim.elAlertrow=document.getElementById('alertrow')||appendTag('div',{className:'col aco',id:'alertrow'});}}if(!Aim.alerts[alert.id])Aim.alerts[alert.id]=Aim.elAlertrow.appendTag('div',{className:alert.categorie,innerText:[alert.title,alert.created].join(' '),onchange:function(event){if('condition' in this)this.setAttribute('condition',this.condition);if('ack' in this)this.setAttribute('ack',this.ack);if(this.ack&&!this.condition){Aim.alerts[this.id]=null;Aim.elAlertrow.removeChild(this);}},onclick:function(){Aim.wss.send({systemalert:{id:this.id,ack:this.ack=1}});this.onchange();}});Object.assign(Aim.alerts[alert.id],alert).onchange();}},attribute:{type:{text:{createInput:function(){this.elInp=this.elEdit.appendTag('input',{attr:this.attr,className:'ainp aco '+this.name,type:this.type||'',value:this.value,item:this.item,name:this.name,titel:this.title,onchange:Aim.Element.onchange});for(var name in this)if(name in this.elInp)this.elInp[name]=this[name];this.elInp.placeholder=" ";},createSpan:function(){if(this.itemID){this.elSpan=this.elView.appendTag('a',{schema:this.schema||'item',itemID:this.itemID,innerHTML:this.value});}else{this.elSpan=this.elView.appendTag('span',{className:'aco pre wrap '+this.className,type:this.type||'',field:this,innerHTML:this.displayvalue,});}},createEdit:function(name){with(this.elEdit=document.body.appendTag('div',{className:'row field '+(this.type||'text')})){if(this.hidden)setAttribute('hidden','');if(this.checkvisible&&this.item){this.elEdit.className+=' checkvisible';this.elEdit.checkvisible=this.checkvisible.bind(this.item);}this.createInput(this);appendTag('label',{innerText:this.placeholder});}return this.elEdit;},createView:function(name){with(this.elView=document.body.appendTag('div',{className:'row prop '+(this.type||'text')})){appendTag('label',{innerText:this.placeholder});this.createSpan(this);}return this.elView;},},radio:{createRadio:function(el){with(el=el.appendTag('div',{className:'ainp row wrap '+this.item.id+this.name})){this.options=this.options||this.enum;for(var optionname in this.options){var option=this.options[optionname];with(appendTag('span',{className:'radiobtn'})){var forID=this.item.id+this.name+optionname;console.log('SENDDDDDDD1111',this.operation);appendTag('input',{type:'radio',item:this.item,className:forID,name:this.name,value:optionname,id:forID,checked:(optionname==this.value)?1:0,field:this,operation:this.operation,elProperty:el,onclick:!this.operation?Aim.Element.onchange:function(event){console.log('SENDDDDDDD',Aim.client.domain.id,this.item.id,this.name,this.value);var item={id:this.item.id,schema:this.item.schema,typical:this.item.typical,operations:{}};item.operations[this.operation]=this.value.split(',');return false;}});with(appendTag('label',{attr:{for:forID}})){with(appendTag('icon'))if(option.color)style.backgroundColor=option.color;appendTag('span',{innerText:option.title||option});}}}}return el;},createInput:function(){this.elEdit.className+=' fw';with(this.elInp=this.elEdit.appendTag('div',{className:'ainp row wrap'})){this.options=this.options||this.enum;for(var optionname in this.options){var option=this.options[optionname];with(appendTag('span',{className:'radiobtn'})){appendTag('input',{type:'radio',item:this.item,name:this.name,value:optionname,id:this.name+optionname,checked:(optionname==this.value)?1:0,onchange:Aim.Element.onchange});with(appendTag('label',{attr:{for:this.name+optionname}})){with(appendTag('icon'))if(option.color)style.backgroundColor=option.color;appendTag('span',{innerText:option.title||option});}}}with(appendTag('span',{className:'radiobtn'})){appendTag('input',{type:'radio',item:this.item,name:this.name,value:'',id:this.name+'clear',checked:(!this.value)?1:0,onchange:Aim.Element.onchange});with(appendTag('label',{attr:{for:this.name+'clear'}})){appendTag('icon').style.backgroundColor='#ccc';}}}},createSpan:function(item){this.elSpan=this.createRadio(this.elView);},},meter:{createSpan:function(item){this.elSpan=this.elView.appendTag('meter',{className:'aco '+this.name,titel:this.title,field:this,attr:this.attr,value:''});},},check:{createInput:function(){this.elEdit.className+=' fw';var values=this.value.split(',');with(this.elInp=this.elEdit.appendTag('div',{className:'ainp row wrap'})){this.options=this.options||this.enum;for(var optionname in this.options){var option=this.options[optionname];with(appendTag('span',{className:'radiobtn check'})){appendTag('input',{el:this.elInp,type:'checkbox',id:this.name+optionname,value:optionname,checked:(values.indexOf(optionname)!=-1)?1:0,onclick:function(event){var c=this.elEdit.getElementsByTagName('input');var a=[];for(var i=0,e;e=c[i];i++)if(e.checked)a.push(e.value);this.elEdit.newvalue=a.join(',');}});with(appendTag('label',{attr:{for:this.name+optionname}})){appendTag('icon').style.backgroundColor=option.color;appendTag('span',{innerText:option.title});}}}}}},select:{createInput:function(){with(this.elInp=this.elEdit.appendTag('select',{className:'ainp row aco',item:this.item,name:this.name,onchange:Aim.Element.onchange})){if(Object.prototype.toString.call(this.options)==='[object Array]'){for(var i=0,optionvalue;optionvalue=this.options[i];i++)appendTag('option',{value:optionvalue,innerText:optionvalue});}else for(var optionname in this.options){var option=this.options[optionname];appendTag('option',{value:optionname,innerText:option.title||option});}this.elInp.value=this.value;}}},selectitem:{createInput:function(){with(this.elEdit){className+=' search';Object.assign(this.elInp=this.elEdit.appendTag('input',{className:'ainp aco',type:this.type||'',placeholder:'',titel:this.title,field:this,classID:String(this.classID).split(';').shift(),post:{exec:'itemItemsGet',id:';'+this.classID},onchange:Aim.Element.onchange,}),this,Aim.Element.Pulldown);}}},checklist:{createInput:function(){with(this.elInp=this.elEdit.appendTag('select',{})){for(var optionname in this.options){appendTag('option',{value:optionname,innerText:this.options[optionname].title||optionname});}}},},address:{createInput:function(){with(this.elEdit){this.elInp=appendTag('input',{className:'ainp'},{placeholder:""});var addressField=this;var fields=[{Street:{},Number:{},Add:{}},{PostalCode:{},City:{}},{Town:{},State:{},Country:{}},]fields.forEach(function(row){with(this.elEdit.appendTag('div',{className:'row wrap'})){for(var name in row){with(appendTag('span',{className:'field'})){addressField[name]=appendTag('input',{className:'ainp',placeholder:'',onchange:Aim.Element.onchange});appendTag('label',{innerText:name});}}}},this);addressField.autocomplete=new google.maps.places.Autocomplete(this.elInp,{types:['geocode']});this.elInp.placeholder=' ';addressField.autocomplete.address=addressField;this.elInp.onkeydown=function(event){if(event.key=='Enter'){event.stopPropagation();event.preventDefault();}}addressField.autocomplete.addListener('place_changed',function(event){var place=this.getPlace();this.properties={};var adrescomp={};if(place.address_components)for(var i=0,comp;comp=place.address_components[i];i++){for(var j=0,compname;compname=comp.types[j];j++){adrescomp[compname]=comp.long_name;}}console.log('GEO',this,this.address.location);var fields={Street:adrescomp.route||adrescomp.sublocality_level_2||adrescomp.sublocality,Number:adrescomp.street_number,PostalCode:adrescomp.postal_code,City:adrescomp.locality,Town:adrescomp.administrative_area_level_2 !=adrescomp.locality?adrescomp.administrative_area_level_2:null,State:adrescomp.administrative_area_level_1,Country:adrescomp.country,}for(var name in fields)this.address[name].field.value=this.address[name].value=fields.name||this.address[name].field.value;if(this.address.location){this.address.item.setAttribute('location',[place.geometry.location.lat(),place.geometry.location.lng()].join(','));}});this.elInp=addressField[this.addressField];}},},textarea:{createInput:function(){this.elEdit.className='field col fw';this.elInp=this.elEdit.appendTag('textarea',{className:'ainp',value:this.value,item:this.item,name:this.name,titel:this.title,placeholder:" ",onchange:Aim.Element.onchange});this.elInp.onkeyup=function(event){this.style.height='0px';this.style.height=(this.scrollHeight+24)+'px';}this.elInp.onkeyup();},},json:{createInput:function(){this.elEdit.className='field col fw';this.elInp=this.elEdit.appendTag('code').appendTag('textarea',{className:'ainp oa',style:'white-space:nowrap;',value:editor.json(this.value)});this.elInp.addEventListener('change',function(){try{JSON.parse(this.value,true)}catch(err){alert('JSON format niet in orde;');}});this.elEdit.appendTag('label',{innerText:this.placeholder});this.elInp.onkeyup=function(event){if(this.style.height<300){this.style.height='auto';this.style.height=Math.min(this.scrollHeight+20,300)+'px';}}setTimeout(function(el){this.elEdit.onkeyup();},100,this.elInp);},},div:{createInput:function(){this.elEdit.className='field col fw';this.elInp=this.elEdit.appendTag('div',{className:'ainp',innerHTML:this.value,item:this.item,name:this.name,titel:this.title,placeholder:" ",onblur:Aim.Element.onchange,attr:{contenteditable:''}});document.getElementById('ckeTop').innerText='';CKEDITOR.inline(this.elInp,{extraPlugins:'sharedspace',sharedSpaces:{top:'ckeTop'},on:{focus:function(){OM.elEdit.insertBefore(document.getElementById('ckeTop'),items.elEditBtnBar);document.getElementById('ckeTop').style="position:absolute;margin:auto;left:0;right:0;z-index:100;";},blur:function(event){document.body.appendChild(document.getElementById('ckeTop'));document.getElementById('ckeTop').style="display:none;";},}});},},checkbox:{createInput:function(){this.elEdit.className='field col fw';with(this.elEdit.appendTag('span',{className:'radiobtn'})){this.elInp=appendTag('input',{type:'checkbox',name:this.name,id:this.name+'clear',checked:(this.value)?1:0});with(appendTag('label',{attr:{for:this.name+'clear'}})){appendTag('icon').style.backgroundColor='#ccc';appendTag('span',{innerText:this.title});}}},},file:{createInput:function(){},},date:{createInput:function(){this.elInp=this.elEdit.appendTag('input',{className:'ainp aco',type:this.type||'',placeholder:'',titel:this.title,value:String(this.value).substr(0,10),field:this,onchange:Aim.Element.onchange});},},email:{},tel:{},url:{},linkedin:{},skype:{},html:{},},},functionSend:function(){if(this.arguments){for(var i=0,l=Math.max(arguments.length,this.arguments.length);i<arguments.length;i++)if(this.arguments[i] !=arguments[i])break;if(i>=l)return;}this.arguments=Array.prototype.slice.call(arguments);console.log('SEND TO DEVICE',this.id,this.schema,this.typical,this.functionname,this.arguments);var item={id:this.id,schema:this.schema,typical:this.typical,operations:{}};item.operations[this.functionname]=this.arguments;Aim.wss.send({to:[Aim.client.domain.id],value:[item]});},statemodelEval:function(){console.log('statemodelEval',this.statemodel);if(!this.statemodel)return;for(var name in this.statemodel){if(!this.state)return this.statemodelSet(name);var state=this.statemodel[name];if(this.statemodel[name].trigger&&this.statemodel[name].trigger[this.state]&&this.statemodel[name].trigger[this.state].call(this))return this.statemodelSet(name);}if(this.statemodel[this.state].do)this.statemodel[this.state].do.call(this);},proxyItems:function(dataItems){addref=function(item,ref){if(Array.isArray(item[ref.typical])){if(item[ref.typical].indexOf(ref)==-1)item[ref.typical].push(ref);}else if(item[ref.typical]){if(item[ref.typical] !=ref)item[ref.typical]=[item[ref.typical],ref];}else item[ref.typical]=ref;}var proxyItems=[];dataItems.forEach(function(item){item.linkAll=[];for(var name in item.operations)item[name]=((item[item.operations[name].stereotype]=item[item.operations[name].stereotype]||{})[name]=item.operations[name])[Aim.app]||Aim.functionSend.bind({functionname:name,id:item.id,schema:item.schema,typical:item.typical,item:item});for(var name in item.properties)item[name]=item.properties[name].type=="array"?[]:item.properties[name].initvalue?item.properties[name].initvalue:item[name];Object.assign(item,{statemodelSet:function(name){console.log('set state',this.state,name);if(this.state==name)return;if(this.statemodel[this.state]&&this.statemodel[this.state].exit)this.statemodel[this.state].exit.call(this);if(this.statemodel[name].entry)this.statemodel[name].entry.call(this);this.state=name;if(this.el&&this.el.state)this.el.state.value=this.state;},statemodelEval:Aim.statemodelEval,timerSet:function(ms){this.timerPassed=false;clearTimeout(this.to);this.to=setTimeout(function(){this.timerPassed=true;this.statemodelEval();this.timerPassed=false;}.bind(this),ms);},});api.item[item.id]=proxyItems[item.id]=Aim.itemProxy?new Proxy(item,Aim.itemProxy):item;});proxyItems.forEach(function(item){(function addToMaster(master){if(!master||!master.linkAll)return;master.linkAll.push(this);addToMaster.call(this,master.master);}).call(item,item.master)if(item.linkto)for(var id in item.linkto)if(item.linkto[id]=='Link'){(function addToMaster(linkitem){if(!this.linkAll)return;this.linkAll.push(linkitem);linkitem.children.forEach(addToMaster.bind(this));}).call(item,api.item[id]);console.log('Link',item);}});proxyItems.forEach(function(master){master.linkAll.forEach(function(item){if(!Number(item.id))return;console.log(item.id,item,api.item[item.id]);item=api.item[item.id];if(!item.typical)return;addref(master,item);})master.children.sort(function(a,b){return a.idx>b.idx?1:(a.idx<b.idx?-1:0)});master.children.forEach(function(child){child=api.item[child.id];if(Array.isArray(master[child.schema]))master[child.schema].push(child);else master[child.schema]=[child];(function drillsoftwarefunctions(child){if(!Number(child.id))return;child=api.item[child.id];if(child.schema=='softwarefunction'){master.linkAll.forEach(function(item){if(item.schema !='softwarefunction'||!item.typical||item.master.id==child.id||item.id==child.id)return;addref(child,item);addref(item,child);})child.children.forEach(drillsoftwarefunctions);}})(child)})});return proxyItems;},createElement:function(par){if(!par)throw 'no par';var ele=document.createElement(par.tag||'div');if(par.event){for(var name in par.event)ele.addEventListener(name,par.event[name]);par.event=null;}if(par.attr){for(var name in par.attr)if(par.attr[name] !=undefined)ele.setAttribute(name,par.attr[name]);delete(par.attr);}for(var name in par){try{ele[name]=par[name];}catch(err){}}return ele;},window:{Date:{maand:["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"],stamp:function(){return new Date().toISOString().replace(/T|Z/g, ' ');},prototype:{monthDays:function(){var d=new Date(this.getFullYear(),this.getMonth()+1,0);return d.getDate();},getMaand:function(){return Date.maand[this.getMonth()];},getWeek:function(){var d=new Date(+this);d.setHours(0,0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));return Math.ceil((((d-new Date(d.getFullYear(),0,1))||8.64e7)+1)||7);},getWeekday:function(){return(this.getDay()+6)% 7;},toDateText:function(full){var res='';if(this){var tToday=date.localdate();var dagen=(this.getTime()-tToday.getTime())||24||60||60||1000;var res=(!dagen?'Vandaag':dagen==-1?'Gisteren':day[this.getDay()])+' '+this.getDate()+' '+this.getMaand()+' '+this.getFullYear()+',week '+this.getWeek();}return res;},toDateTimeText:function(full){var res=this.toDateText();if(this.getHours()||this.getMinutes())res+=this.toLocaleTimeString().substr(0,5);},toLocal:function(){this.setTime(this.getTime()-this.getTimezoneOffset()*60*1000);return this;},toWeekDay:function(){return this.getFullYear()+'-'+this.getWeek()+' '+day[this.getDay()];},toString:function(){},toDateTimeStr:function(length){var s=this.getFullYear()+'-'+(this.getMonth()+1).pad(2)+'-'+this.getDate().pad(2);if(this.getHours()!=0&&this.getMinutes()!=0&&this.getSeconds()!=0)s+=' '+this.getHours().pad(2)+':'+this.getMinutes().pad(2)+':'+this.getSeconds().pad(2);+'.'+this.getMilliseconds().pad(3);return s.substring(0,length);},toDateTimeStringT:function(){return this.getFullYear()+'-'+(this.getMonth()+1).pad(2)+'-'+this.getDate().pad(2)+'T'+this.getHours().pad(2)+':'+this.getMinutes().pad(2)+':'+this.getSeconds().pad(2)+'.'+this.getMilliseconds().pad(3);},toShortStr:function(){return this.getDate().pad(2)+'-'+(this.getMonth()+1).pad(2)+' '+this.getHours().pad(2)+':'+this.getMinutes().pad(2);},toLocalDBString:function(){this.setTime(this.getTime()-this.getTimezoneOffset()*60*1000);return this.toISOString().replace(/T|Z/g, ' ');},}},Number:{prototype:{formatMoney:function(c,d,t){var n=this,c=isNaN(c=Math.abs(c))?2:c,d=d==undefined?",":d,t=t==undefined?".":t,s=n<0?"-":"",i=parseInt(n=Math.abs(+n||0).toFixed(c))+"",j=(j=i.length)>3?j % 3:0;return s+(j?i.substr(0,j)+t:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+t)+(c?d+Math.abs(n-i).toFixed(c).slice(2):"");},pad:function(size){var s=String(this);while(s.length<(size||2)){s="0"+s;}return s;},}},String:{prototype:{capitalize:function(){return this.charAt(0).toUpperCase()+this.slice(1);}}},Element:{prototype:{appendPar:function(par){return this.appendChild(Aim.createElement(par));},appendTag:function(tag,par){(par=par||{}).tag=tag;if('open' in par){(par.attr=par.attr||{}).open=par.open;par.onclick=par.onclick||Aim.Element.onclick;}if('send' in par)par.onclick=par.onclick||function(){Aim.wss.send(this.send);};var el=this.appendPar(par);if(tag=='a'&&par.itemID)Aim.Element.popup(el);if(el.rewrite)el.rewrite();if(el.contextmenu&&Aim.showcontextmenu)el.oncontextmenu=Aim.popup.show;if(el.popupmenu){el.onclick=Aim.popup.show;el.appendTag('i',{className:'ico-down'});}return el;},appendTags:function(a){for(var i=0,child;child=a[i];i++){var ele=this.appendTag(child.tag||'div',child);if(child.children)ele.appendTags(child.children);}},attrToggle:function(name){if(this.getAttribute(name)!='')this.setAttribute(name,'');else this.removeAttribute(name);},appendText:function(s){return this.appendChild(document.createTextNode(s));},bringtofront:function(){this.parentElement.appendChild(this);},attrToggle:function(name){if(this.getAttribute(name)!='')this.setAttribute(name,'');else this.removeAttribute(name);},}},Object:{forEach:function(obj,fn){if(!obj)return;var i=0;for(var name in obj){if(fn.apply(this,[obj[name],name,i++])==false)return;}},forEachSorted:function(obj,fn){if(!obj)return;var a=[],i=0;for(var name in obj)a.push({name:name,obj:obj[name],index:i++});a.sort(function(a,b){return a.name>b.name?1:a.name<b.name?-1:0;});a.forEach(function(row,i){fn.apply(this,[row.obj,row.name,row.index,i]);});},}},events:{popstate:function(event){if(Aim.hisHash !=document.location.hash)Aim.URL.exec((Aim.hisHash=document.location.hash).substr(1),1);else Aim.URL.exec(document.location.search.substr(1),2);},},loadevents:[],merge:function(){var sources=Array.prototype.slice.call(arguments),target=sources.shift(),objects=[];sources.forEach(function recurse(source){if(objects.indexOf(source)!=-1)return;objects.push(source);if(typeof source !=='object')return source;for(var prop in source){if(Object.prototype.toString.call(source[prop])==='[object Object]'){if(!(prop in this))this[prop]=source[prop];else recurse.call(this[prop],source[prop]);}else{this[prop]=source[prop];}}return target;},target);return target;},add:function(source){Aim.merge(Aim,source);if(!('manual' in get))if('events' in source)for(var eventName in source.events){if(eventName=='load')Aim.loadevents.push(source.events[eventName]);else window.addEventListener(eventName,source.events[eventName]);}},createButtonbar:function(el,buttons){el.className="row top btnbar np";for(var name in buttons)if(Object.values(buttons[name]).length&&!buttons[name].hidden)buttons[name].el=el.appendTag('button',Object.assign({onclick:Aim.Element.onclick},buttons[name],{className:name+' abtn icn '+(buttons[name].className||'')}));},cache:{},get:function(row){row=typeof row=='object'?row:{id:row};return api.item[row.id]||api.onload(row);},cookie:document.cookie?JSON.parse('{"'+document.cookie.replace(/=/g, '":"').replace(/; /g, '","').replace(/\",/g, '",')+'"}'):{},//cookie:{//set:function(name,value){//document.cookie=name+'='+value;//},//get:function(name,defaultvalue){////console.log(document.cookie);//var acookie=(' '+document.cookie).split(' '+name+'=');//return acookie.length==2?acookie.pop().split(';').shift():defaultvalue;////console.log('GET COOKIE',name,document.cookie.split(name+'=').pop().split(';').shift());////return document.cookie.split(name+'=').pop().split(';').shift();////console.log('GET COOKIE',name,document.cookie);//}//},statusbar:{message:function(message){//console.log("new",message);if(!Aim.statusbar.container)Aim.statusbar.container=document.body.appendTag('div',{className:'statusbar'});return Aim.statusbar.container.appendTag('span',{innerText:message,remove:function(event){if(this.parentElement)this.parentElement.removeChild(this);}});},//consoleMessage:function(){//var argumentsList=Array.prototype.slice.call(arguments);//console.log.apply(this,argumentsList);//return Aim.statusbar.appendMessage(argumentsList.join(" "));//},//removeMessage:function(el){//if(Aim.statusbar.elementMessage)Aim.statusbar.elementMessage.removeChild(el);//},},load:function(par){//if(par.asrc)par.src=par.asrc;//else//console.log(par.get);//console.log('LOAD',par.src,par.api,apiorigin);//par.src=par.src?((par.src.substr(0,4)=='http'||par.src[0] !='/')?par.src:Aim.origin+par.src):(par.api&&par.api.indexOf('://')!=-1?par.api:(par.get&&par.get.origin?par.get.origin:[Aim.origin,Aim.host,Aim.version,'api',par.api||''].join('/')));//par.src=par.src?((par.src.substr(0,4)=='http'||par.src[0] !='/')?par.src:apiorigin+par.src):(par.api&&par.api.indexOf('://')!=-1?par.api:(par.get&&par.get.origin?par.get.origin:[Aim.origin,Aim.host,Aim.version,'api',par.api||''].join('/')));var src=par.src?(par.src[0]=='/'?apiorigin:"")+par.src:(apiorigin+"/"+Aim.host+"/"+Aim.version+"/api/"+(par.api||''));//console.log('qqqq',Aim.host,Aim.version);//console.log('LOAD',par.src,par.api);//console.log('Aim.load',Aim.version,par.src,par,Aim.origin,Aim.host,Aim.host1);if(par.cache&&Aim.cache[par.api]){par.data=Aim.cache[par.api];return par.onload?par.onload.call(par):null;}if(!src)throw "no src";var formdata=par.put?JSON.stringify(par.put):par.post?new FormData():null;for(var name in par.post)formdata.append(name,par.post[name]||'');if(this.err)this.err.innerText='';if(this.msg)this.msg.innerText='';var src=encodeURI(src+(par.get?'?'+Aim.URL.stringify(par.get):''));var xhr=new XMLHttpRequest();xhr.par=par;xhr.caller=arguments.callee.caller;if(document.getElementById("loadlog")){xhr.elLoadlog=document.getElementById("loadlog").appendTag("div");xhr.elLoadlog.appendTag('span',{innerText:par.title});xhr.elLoadlog.appendTag('span',{innerText:new Date().toLocaleString()});}if(src[0]==':')src='http'+src;xhr.open(par.method?par.method:par.put?'put':par.post?'post':'get',xhr.src=src,true);xhr.withCredentials=true;if(par.header)for(var name in par.header)xhr.setRequestHeader(name,par.header[name]);//xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");//xhr.setRequestHeader("User-Agent","Aliconnect/ObjectManager");//xhr.setRequestHeader("Authorization","Bearer "+Aim.accessToken);//xhr.setRequestHeader("Accept","application/json");//xhr.setRequestHeader("client-request-id",Aim.makeGuid());//xhr.setRequestHeader("return-client-request-id",true);//xhr.setRequestHeader("X-AnchorMailbox",Aim.user.email);//if(par.method=='POST'){//xhr.setRequestHeader("Content-Type",'application/json');//}//if(par.method=='PATCH'){//xhr.setRequestHeader("Content-Type",'application/json');//}//if(par.put||document.location.origin=='file://')xhr.setRequestHeader('Content-type','application/json;charset=utf-8');//xhr.setRequestHeader('Content-type','application/json;charset=utf-8');//xhr.setRequestHeader('Content-type','text/xml');//collist.innerText=par.src;//if(document.body&&document.body.getAttribute)document.body.setAttribute('wait',xhr.wait=Number(document.body.getAttribute('wait'))+1);//for(var name in par)if(par[name])xhr[name]=par[name];xhr.elSbMsg=new Aim.statusbar.message(src.split('?').shift());if(par.get){if(par.get.folder&&window.collist)window.collist.setAttribute('wait',xhr.waitfolder=Number(window.collist.getAttribute('wait'))+1);if(par.get.id&&window.colpage)window.colpage.setAttribute('wait',xhr.waitpage=Number(window.colpage.getAttribute('wait'))+1);};xhr.addEventListener('load',function(event){//console.log('Loaded',this.src,this.caller);console.log('Loaded',this.src,this.par.put||'');if(this.elLoadlog)this.elLoadlog.appendTag('span',{innerText:new Date().toLocaleString()});if(this.waitfolder)window.collist.setAttribute('wait',Number(window.collist.getAttribute('wait'))-1);if(this.waitpage)window.colpage.setAttribute('wait',Number(window.colpage.getAttribute('wait'))-1);if(this.elSbMsg)xhr.elSbMsg.remove();/||Aim.statusbar.removeMessage(this.elSbMsg);if(this.responseText){//collist.innerText=par.src;if(["{","["].indexOf(String(this.responseText).trim()[0])!=-1)try{this.data=JSON.parse(this.responseText,true);}catch(err){console.log(this.src,this.caller,this.responseText);}else if(this.responseText[0] !="<")console.log(this.src,this.responseText,this.caller);event.par=this.par;if(event.data=this.data){Aim.cache[this.api]=this.data;if(this.data.errors&&this.sender.err){this.sender.err.appendTag('p',{innerText:this.data.errors[0].message.replace(/\[.*?\]/g, '')});console.log(this.data.errors);}if(this.sender&&this.sender.msg){if(this.data.message)this.sender.msg.appendTag('p',{innerText:this.data.message});else this.sender.msg.innerText='';}if(this.data.err)alert(this.data.err+Aim.client.user.id);//else if(this.api&&Object.prototype.toString.call(this.data)==='[object Object]'){//console.log('data',this.data);//if(this.data.value)var value=this.data.value||[this.data];value.get=this.get;value.forEach(api.onload);//if(this.data.value&&this.data.value.forEach){//this.data.value.get=this.get;//this.data.value.forEach(api.onload);//}//console.log('LOAD',this.src,this.data,this.responseText);//else Aim.merge({api:this.data});//}//console.log('Loaded',this.src,this.data);}}});Object.assign(xhr,par);xhr.sender=this;var path=xhr.src.split('//').pop().split('?').shift().split('/');path.shift();path.shift();path.shift();xhr.schema=path.shift();xhr.id=path.shift();if(!xhr.onload&&api.definitions&&api.definitions[xhr.schema]){xhr.addEventListener('load',!isNaN(xhr.id)?api.definitions[xhr.schema].onloadrow||App.onloadrow:api.definitions[xhr.schema].onloadrows||App.onloadrows);}//console.log(xhr.onload);//console.log('Load',xhr.src);//xhr.overrideMimeType("application/json");xhr.send(formdata);return xhr;},loadscripts:function(){var src=this.scripts.shift();if(!src)return this.caller();console.log('loading',src);document.body.appendTag('script',{src:src,caller:this.caller||arguments.callee.caller,par:this.par,scripts:this.scripts,onload:Aim.loadscripts});},play:function(url){return new Promise(function(resolve,reject){/||return a promisevar audio=new Audio(url); ||||create audio wo||srcaudio.preload="auto"; ||||intend to play throughaudio.autoplay=true; ||||autoplay when loadedaudio.onerror=reject; ||||on error,rejectaudio.onended=resolve; ||||when done,resolve//audio.src=url;/||just for exampleconsole.log(audio);});},//stylesheet:(function(){visibility//var style=document.createElement("style");//style.appendChild(document.createTextNode(""));//document.head.appendChild(style);//return style.sheet;//})(),cssRuleAdd:function(selector,rules,index){index=0;Aim.stylesheet=Aim.stylesheet||document.head.appendTag('style').sheet;if("insertRule" in Aim.stylesheet)Aim.stylesheet.insertRule(selector+"{"+rules+"}",index);else if("addRule" in Aim.stylesheet)Aim.stylesheet.addRule(selector,rules,index);},scripts:Object.assign([],{append:function(src){this.push(src);if(!Aim.scripts.scr)this.load();},load:function(){if(Aim.scripts.scr=Aim.scripts.shift())document.head.appendTag('script',{type:'text/javascript',charset:'UTF-8',src:Aim.scripts.scr,async:true,defer:true,onload:Aim.scripts.load});},}),loadData:Object.assign([],{next:function(){if(this.par=this.shift())return Aim.load(this.par);Aim.loadevents.forEach(function(fn){fn();});//console.log('AAAAA',get.id,get.schema);if(get.id&&get.schema)Aim.URL.set({id:get.id,schema:get.schema},2);if(document.location.search)Aim.URL.exec(document.location.search.substr(1),2);//console.log('AAAAA',get.id,get.schema);if(document.location.hash)Aim.URL.exec(document.location.hash.substr(1),2);}}),appendHead:{css:function(sources,path){sources.forEach(function(src){document.head.appendTag('link',{rel:'stylesheet',href:path?path+src+'.css':src});})},//js:function(sources,path){sources.forEach(function(src){document.head.appendTag('script',{type:'text/javascript',charset:'UTF-8',src:path?path+src+'.js':src,async:true,defer:true});})},js:function(sources,path){sources.forEach(function(src){document.head.appendTag('script',{type:'text/javascript',charset:'UTF-8',src:path?path+src+'.js':src,defer:true});})},},//aliconnect:aliconnect,maps:{showonmap:function(href){with(Listview.elOa){innerText='';this.mapel=appendTag('div',{className:'googlemap',style:'width:100%;height:100%;'});OM.map=new google.maps.Map(this.mapel,{zoom:8});bounds=new google.maps.LatLngBounds();geocoder=new google.maps.Geocoder();var address=decodeURI(href).split('/').pop();console.log(address);geocoder.geocode({'address':address},function(results,status){if(status==google.maps.GeocoderStatus.OK){var marker=new google.maps.Marker({map:OM.map,position:results[0].geometry.location});bounds.extend(marker.getPosition());OM.map.fitBounds(bounds);google.maps.event.addListenerOnce(OM.map,'bounds_changed',function(){this.setZoom(Math.min(10,this.getZoom()));});}else{console.log('Geocode was not successful for the following reason:'+status);}});}},init:function(){//document.head.appendTag('script',{src:document.location.protocol+"this.geocoder=new google.maps.Geocoder();this.latlng=new google.maps.LatLng(-34.397,150.644);this.mapOptions={zoom:15,center:this.latlng,mapTypeId:google.maps.MapTypeId.ROADMAP};}},wss:Aim.messeger={msgs:[],log:function(){Aim.wss.elementStatus=Aim.wss.elementStatus||new Aim.statusbar.message("");var argumentsList=Array.prototype.slice.call(arguments);Aim.wss.elementStatus.innerText=argumentsList.join(" ");},wss:{onopen:function(event){Aim.wss.log("Websocket connected",Aim.config.wss.url);Aim.wss.websocket.send(JSON.stringify({login:Aim.client}));Aim.on.onopen.forEach(function(fn){fn.call(Aim.wss.websocket,event);});},onclose:function(event){Aim.wss.log("Websocket reconnecting");Aim.wss.sTo=setTimeout(Aim.wss.connect,5000);Aim.on.onclose.forEach(function(fn){fn.call(Aim.wss.websocket,event);});},onerror:function(event){Aim.wss.log("Websocket error");Aim.on.onerror.forEach(function(fn){fn.call(Aim.wss.websocket,event);});},onmessage:function(event){var data=this.data=event.data[0]=='{'?JSON.parse(event.data):event.data;if(this.data.login&&!this.client){Aim.client=this.data.login;this.client=this.data.from;console.log("wss client",this.data.login);console.log("wss client",this.client.client);Aim.on.onconnect.forEach(function(fn){fn.call(Aim.wss.websocket,event);});Aim.wss.sendbuf();return;}if(data.Notification)Aim.Notification.create(data.Notification);if(data.systemalert)Aim.Alert.appendAlert(data.systemalert);if(this.data.value&&Array.isArray(this.data.value))this.data.value.forEach(function(row){if(row.attr){for(var i=0,e,c=document.getElementsByClassName(row.id);e=c[i];i++){if(row.attr)for(var name in row.attr)if(row.attr[name])e.setAttribute(name,row.attr[name]);else e.removeAttribute(name);}}if(!api.item[row.id])return;if(row.values){for(var attributeName in row.values)if(row.values[attributeName] !=undefined){api.item[row.id].setAttribute(attributeName,typeof row.values[attributeName]=="object"?row.values[attributeName].value:row.values[attributeName],true);}api.item[row.id].refreshAttributes();}});Aim.on.onmessage.forEach(function(fn){fn.call(Aim.wss.websocket,event,data);});Aim.wss.elementStatus.remove();return;if(data.itemID&&data.attributeName&&('value' in data)){c=document.getElementsByName([data.itemID,data.attributeName].join('.'));for(var i=0,e;e=c[i];i++)e.setAttribute('value',data.value);var c=document.getElementsByClassName(data.itemID);for(var i=0,e;e=c[i];i++)e.setAttribute(data.attributeName,data.value);if(window.meshitems&&window.meshapi.item[data.itemID]&&data.attributeName=='MeshColor'){window.meshapi.item[data.itemID].src.basiccolor=data.value;window.meshapi.item[data.itemID].colorSet(data.value);}if(window.meshitems&&window.meshapi.item[data.itemID]&&data.attributeName=='err'){var c=OM.elErr.children;for(var i=0,elErrRow;elErrRow=c[i];i++)if(elErrRow.meshitem.src.itemID==data.itemID)break;if(elErrRow){elErrRow.elEnd.innerText=(elErrRow.end=new Date()).toISOString().substr(11,8);elErrRow.refresh();}else with(OM.elErr.insertBefore(elErrRow=OM.elErr.appendTag('div',{className:'row err start',onclick:Aim.Element.onclick,itemID:data.itemID,meshitem:window.meshapi.item[data.itemID],start:new Date()}),OM.elErr.firstChild)){appendTag('span',{className:'icon'});appendTag('span',{className:'',innerText:window.meshapi.item[data.itemID].src.name});appendTag('span',{className:'',innerText:data.value});appendTag('span',{className:'',innerText:elErrRow.start.toISOString().substr(11,8)});elErrRow.elAccept=appendTag('span',{className:'',innerText:''});elErrRow.elEnd=appendTag('span',{className:'',innerText:''});elErrRow.refresh=function(){if(this.end&&this.accept){this.meshitem.colorSet();OM.elErr.removeChild(this);}OM.elErrCont.style=OM.elErr.children.length?'':'display:none;';window.onWindowResize();};elErrRow.refresh();}}}},},onload:function(){Aim.wss.elConsole=Aim.wss.elConsole||document.body.appendTag('div',{className:'wsmessage'});},connect:function(data){if(!Aim.config.wss)return;Aim.wss.log("Websocket connecting",Aim.config.wss.url);Aim.wss.websocket=Object.assign(new WebSocket(Aim.config.wss.url),Aim.wss.wss);if(data)Aim.wss.send(data);},sendbufshift:function(){var data=Aim.wss.msgs.shift();if(!data)return false;data.to=data.to||[];if(Aim.client.domain&&data.to.indexOf(Aim.client.domain.id)==-1)data.to.push(Aim.client.domain.id);Aim.wss.websocket.send(JSON.stringify(data));},sendbuf:function(){while(Aim.wss.msgs.length&&!Aim.wss.hold)Aim.wss.sendbufshift();},send:function(data){Aim.wss.msgs.push(data);if(!Aim.wss.websocket||Aim.wss.websocket.readyState !=1)return;Aim.wss.sendbuf();},initProperties:function(){var itemsInit=[];api.item.forEach(function(item){var itemInit=null;for(var name in item.properties)if(item.properties[name].initRT){(itemInit=itemInit||{id:item.id,values:[]}).values.push(name);}if(itemInit)itemsInit.push(itemInit);});console.log('itemsInit',itemsInit);Aim.wss.send({to:[Aim.client.domain.id],init:itemsInit});}},beforeLoad:function(){if(Aim.head&&Aim.head.css)Aim.appendHead.css(Aim.head.css);if(Aim.head&&Aim.head.js)Aim.scripts.append(Aim.head.js);},libraryShow:function(script){console.log(this);if(this.show)this.show();if(!('script' in this))this.script=script;if(this.script.length){document.head.appendTag('script',{type:'text/javascript',charset:'UTF-8',src:this.src=this.script.shift(),onload:arguments.callee.bind(this)});console.log(this.src);}},popupmenu:{className:'col popup',enter:function(event){console.log('ENTER');event.stopPropagation();if(this.elMenu.menuitemFocused)this.elMenu.menuitemFocused.removeAttribute('focus');this.elMenu.menuitemFocused=this;this.elMenu.menuitemFocused.setAttribute('focus','');if(this.elMenu==Aim.popup)Aim.sub.innerText='';if(this.menu)Aim.sub.show.call(this);},show:function(event){var menu=Aim.sub;if(event){event.preventDefault();event.stopPropagation();var menu=Aim.popup;}this.menu=this.popupmenu||this.contextmenu;if(this.popupmenu)this.right=0;var pos=this.getBoundingClientRect();console.log('PUMENU',this.menu,menu,pos);with(menu){innerText='';for(var menuname in this.menu){var menuitem=this.menu[menuname];if(menuitem.hidden)continue;var a=appendTag('a',Object.assign({className:'row abtn icn '+(menuitem.className||menuname),elMenu:menu,left:5,menuitem:menuitem,popupmenu:menuitem.menu,item:this.item,onclick:menuitem.onclick||this.menu.onclick,onmouseenter:Aim.popup.enter},menuitem));if(menuitem.href)a.href=menuitem.href;if(menuitem.color)a.appendTag('icon',{}).style.backgroundColor=menuitem.color;a.appendTag('div',{innerText:menuitem.title});if(menuitem.key)a.appendTag('span',{innerText:menuitem.key});};var top=pos.top;if('right' in this){var left=pos.right-clientWidth,top=pos.bottom;}else if('left' in this){var left=pos.right;}else{var left=event.clientX,top=event.clientY;}style.left=Math.max(0,left)+'px';style.top=Math.min(top,document.body.clientHeight-clientHeight-10)+'px';}},close:function(event){Aim.popup.innerText='';Aim.sub.innerText='';},},on:{onload:[],onopen:[],onmessage:[],onclose:[],onerror:[],onconnect:[],set load(fn){this.onload.push(fn);},set open(fn){this.onopen.push(fn);},set message(fn){this.onmessage.push(fn);},set close(fn){this.onclose.push(fn);},set error(fn){this.onerror.push(fn);},set connect(fn){this.onconnect.push(fn);},},});get=Aim.URL.parse(document.location.href);Aim.add({client:{app:Aim.app},events:Aim.events,});Aim.merge(window,Aim.window);if(Aim.favicon)document.head.appendTag('link',{rel:"shortcut icon",type:"image/png",id:'favicon',href:(Aim.favicon.substr(0,4)!='http'?apiorigin:'')+Aim.favicon});try{Aim.settings=Aim.settings?JSON.parse(Aim.settings):{};}catch(err){}Aim.foldersOpen=String(Aim.foldersOpen||'').split(',');console.log('AUTH',Aim.client);if('auth' in Aim){Aim.loadData.push({src:apiroot+'auth',onload:function(){console.log("AUTH LOADED",this.src,this.data);Aim.merge(Aim.client,this.data);if(!Aim.client.account||!Aim.client.account.id)return document.location.href=apiorigin+"/auth/?redirect_uri="+encodeURIComponent(document.location.href);Aim.loadData.next();}});}if('fav' in Aim)Aim.loadData.push({src:apiroot+'fav',onload:function(){Aim.api.fav=this.data;Aim.loadData.next();}});if('his' in Aim)Aim.loadData.push({src:apiroot+'his',onload:function(){Aim.his=this.data;Aim.loadData.next();}});window.addEventListener('load',function(){Aim.popup=Object.assign(document.body.appendTag('div'),Aim.popupmenu);Aim.sub=Object.assign(document.body.appendTag('div'),Aim.popupmenu);apiorigin=Aim.httpHost=='localhost'&&Aim.local=='api'?"http://localhost":Aim.config.origin;libroot=apiorigin+"/aim/"+Aim.version+"/lib";apiroot=apiorigin+"/"+Aim.host+"/"+Aim.version+"/api/";'NavTop,NavLeft,Tree,List,Page,Info,Footer,Logo,Banner'.split(',').forEach(function(name){Aim['element'+name]=document.getElementById(name);})api.items=api.item;Aim.loadData.next();Aim.on.onload.forEach(function(fn){fn.call(Aim,event);});Aim.wss.connect();(checkdark=function(){var h=new Date().getHours(),dark=h>=20||h<=7;if(Aim.dark !=dark){document.documentElement.className=document.documentElement.className.replace(/ dark/g, '');if(Aim.dark=dark)document.documentElement.className+=' dark';}setTimeout(checkdark,5000);})();},true);console.log('Aim',Aim);