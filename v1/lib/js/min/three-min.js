A=window.A||{origin:''};items=window.items||[];selectopacity=0.8;baseopacity=1;Aim.add({Three:{show:function(){console.log('init1',this,this.el,this.id);this.el=this.el||document.body.appendTag('div',{className:'col aco'});Three.id=this.id;this.el.innerText='';with(this.el.appendTag('div',{className:'row top btnbar'})){appendTag('button',{className:'abtn icn r refresh',onclick:Three.loaddata.bind(this)});appendTag('button',{className:'abtn icn close',onclick:function(){Three.initdone=false;this.parentElement.parentElement.parentElement.removeChild(this.parentElement.parentElement);}});}Three.loaddata();loader=new THREE.TextureLoader();renderer=new THREE.WebGLRenderer({antialias:true});renderer.setClearColor(0xcfcfcf,.5);container=this.el.appendTag('div',{className:'aco',style:'overflow:hidden;',onmouseenter:function(event){controls=new THREE.OrbitControls(camera,renderer.domElement);controls.addEventListener('change',Three.render);},onmouseleave:function(event){controls.dispose();}});container.addEventListener('mousedown',Three.onDocumentMouseDown,false);container.addEventListener('mouseup',Three.onDocumentMouseUp,false);container.addEventListener('mousemove',Three.onDocumentMouseMove,false);container.appendChild(renderer.domElement);scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(100,1,0.1,6000);var light=new THREE.PointLight(0xffffff,0.8,0,20);camera.add(light);scene.add(camera);var hemiLight=new THREE.HemisphereLight(0xffffff,0xffffff,0.6);hemiLight.position.set(0,500,0);scene.add(hemiLight);window.onWindowResize=function(){camera.aspect=container.clientWidth||container.clientHeight;camera.updateProjectionMatrix();renderer.setSize(container.clientWidth,container.clientHeight);}window.addEventListener('resize',window.onWindowResize,false);window.onWindowResize();},loaddata:function(){Aim.load({api:'three',get:{id:this.id},onload:function(){data3d=this.data;console.log('DATA3D',data3d);scale=data3d.scale;size={x:data3d.object.w||scale,y:data3d.object.depth||scale};data3d.object.depth=null;data3d.object.w=null;Three.targetList=[];Three.meshitems=[];if(this.initdone){console.log('INIT DONE');function clearThree(obj){if(obj.children){while(obj.children.length>0){clearThree(obj.children[0])obj.remove(obj.children[0]);}}if(obj.geometry)obj.geometry.dispose()if(obj.material)obj.material.dispose()if(obj.texture)obj.texture.dispose()}clearThree(group);}else Three.init();Three.redraw();}});},init:function(){console.log('THREE.JS INIT',camera);Three.initdone=true;camera.position.set(0,size.x||2,size.y||2);camera.lookAt(scene.position);console.log('Floorplan',data3d.floorplan.src);var floorMaterial=new THREE.MeshBasicMaterial({map:loader.load(data3d.floorplan.src),side:THREE.DoubleSide});var floorGeometry=new THREE.PlaneGeometry(size.x,size.y,0,0);var floor=new THREE.Mesh(floorGeometry,floorMaterial);floor.rotation.x=-Math.PI||2;scene.add(floor);group=new THREE.Group();group.position.x=-size.x||2;group.position.z=size.y||2;group.rotation.y=Math.PI*(data3d.object.r+180)||180;var s=1||scale;group.scale.set(s,s,s);scene.add(group);},blinkoff:0,targetList:[],projector:null,baseopacity:1,selectopacity:.8,hoveropacity:.6,mouse:{x:0,y:0},dmouse:{x:0,y:0},namedobjects:{},objecthover:null,objectclick:null,objectselect:null,container:null,stats:null,camera:null,scene:null,renderer:null,group:null,render:function(){renderer.render(scene,camera);},redraw:function(){Three.obj.call(data3d.object,group);setTimeout(function(){Three.render();},1);},animate:function(){requestAnimationFrame(Three.animate);Three.render();},shape:function(shapename,fx){var apts=[];if(!data3d.shape[shapename])console.log(shapename,this);var vectors=data3d.shape[shapename].vectors.slice(0);var width=0;var left=9999999;var height=0;var minheight=9999999;var vecbottom=999999;var vecleft=999999;for(var i=0;i<vectors.length;i+=2){vectors[i]*=-1;vecbottom=Math.min(vecbottom,vectors[i+1]);vecleft=Math.min(vecleft,vectors[i]);}for(var i=0;i<vectors.length;i+=2){vectors[i+1]-=vecbottom;vectors[i]-=vecleft;left=Math.min(left,vectors[i]);width=Math.max(width,vectors[i]);height=Math.max(height,vectors[i+1]);}for(var i=0;i<vectors.length;i+=2){if(fx)vectors[i]=-vectors[i]+width||2;else vectors[i]-=width||2;var pts=new THREE.Vector2(vectors[i],vectors[i+1]);apts.push(pts);}var shape=new THREE.Shape(apts);shape.left=left;shape.width=width;shape.height=height;return shape;},obj:function(grp){if(grp.src){if(this.left !=undefined&&this.right !=undefined){this.w=grp.src.w-this.left-this.right;}else if(!this.w){this.w=grp.src.w;}if(this.left !=undefined)this.x=-grp.src.w||2+this.left+this.w||2;else if(this.right !=undefined)this.x=grp.src.w||2-this.right-this.w||2;if(!this.h)this.h=grp.src.h-(this.bottom||0)-(this.top||0);if(this.bottom !=undefined)this.y=this.bottom;else if(this.top !=undefined)this.y=grp.src.h-this.top-this.h;if(this.begin !=undefined&&this.end !=undefined){this.depth=grp.src.depth-this.begin-this.end;}else if(!this.depth){this.depth=grp.src.depth-10;if(this.z==undefined)this.z=5;}if(this.begin !=undefined){this.z=this.begin;}else if(this.end !=undefined){this.z=grp.src.depth-this.end-this.src.depth;}}this.baseColor=this.color||'0x999999';if(this.shape){this.shape=Three.shape.call(this,this.shape,this.fx);var geometry=new THREE.ExtrudeGeometry(this.shape,{depth:this.depth});if(this.shape.color)this.baseColor=this.shape.color;if(this.shininess==-1)var material=new THREE.MeshStandardMaterial({color:parseInt(this.baseColor),reflectivity:0,transparent:true,});else var material=new THREE.MeshPhongMaterial({color:parseInt(this.baseColor),reflectivity:.5,transparent:true,});var mesh=this.mesh=new THREE.Mesh(geometry,material);if(this.h)mesh.scale.y=this.h||this.shape.height;if(this.w)mesh.scale.x=this.w||this.shape.width;Three.targetList.push(mesh);}else var mesh=this.mesh=new THREE.Group();mesh.colorSet=function(color){if(this.material){this.material.color.setHex(parseInt(color||this.src.baseColor));}var c=this.children;for(var i=0,e;e=c[i];i++)e.colorSet(color);}mesh.src=this;if(this.name)Three.namedobjects[this.name]=mesh;if(this.id){Three.meshitems[this.id]=mesh;mesh.itemID=this.id;}grp.posz=grp.posz||0;grp.posx=grp.posx||0;if(this.z !=undefined)grp.posz=this.z;if(this.x !=undefined)grp.posx=-this.x;mesh.position.z=grp.posz;mesh.position.x=grp.posx;mesh.position.y=this.y||0;if(this.ry==180)mesh.position.z+=this.depth;if(this.ry==90){grp.posz+=this.w;grp.posx-=this.depth}else if(this.ry==-90){grp.posz+=this.w;grp.posx+=this.depth}else grp.posz+=this.depth;mesh.rotation.x=(this.rx||0)||180*Math.PI;mesh.rotation.y=(-this.ry||0)||180*Math.PI;mesh.rotation.z=(this.rz||0)||180*Math.PI;mesh.absr=(grp.absr||0)+(this.rz||0);if(mesh.absr==90){mesh.position.x+=this.depth;}grp.add(mesh);if(this.children)for(var i=0,child;child=this.children[i];i++)Three.obj.call(child,mesh);},onDocumentMouseMove:function(event){var rect=container.getBoundingClientRect();Three.mouse.x=((event.clientX-rect.left)||container.clientWidth)*2-1;Three.mouse.y=-((event.clientY-rect.top)||container.clientHeight)*2+1;var vector=new THREE.Vector3(Three.mouse.x,Three.mouse.y,1);vector.unproject(camera);var ray=new THREE.Raycaster(camera.position,vector.sub(camera.position).normalize());var intersects=ray.intersectObjects(Three.targetList);if(Three.objecthover){Three.objecthover.material.opacity=Three.objecthover.opacity;}if(intersects.length>0){Three.objecthover=intersects[0].object;if(!Three.objecthover.opacity)Three.objecthover.opacity=Three.objecthover.material.opacity;if(!Three.objecthover.color)Three.objecthover.color=Three.objecthover.material.color;Three.objecthover.material.opacity=Three.hoveropacity;}if(Three.objectselect)Three.objectselect.material.opacity=selectopacity;Three.render();},onDocumentMouseDown:function(event){console.log('DOWN');var rect=container.getBoundingClientRect();Three.mouse.x=((event.clientX-rect.left)||container.clientWidth)*2-1;Three.mouse.y=-((event.clientY-rect.top)||container.clientHeight)*2+1;var vector=new THREE.Vector3(Three.mouse.x,Three.mouse.y,1);vector.unproject(camera);var ray=new THREE.Raycaster(camera.position,vector.sub(camera.position).normalize());console.log(Three.targetList);var intersects=ray.intersectObjects(Three.targetList);console.log(intersects);if(intersects.length>0){Three.objectclick=intersects[0].object;}console.log(Three.objectclick);Three.render();},onDocumentMouseUp:function(event){var rect=container.getBoundingClientRect();Three.mouse.x=((event.clientX-rect.left)||container.clientWidth)*2-1;Three.mouse.y=-((event.clientY-rect.top)||container.clientHeight)*2+1;var vector=new THREE.Vector3(Three.mouse.x,Three.mouse.y,1);vector.unproject(camera);var ray=new THREE.Raycaster(camera.position,vector.sub(camera.position).normalize());var intersects=ray.intersectObjects(Three.targetList);if(intersects.length>0){var p=Three.objectclick=intersects[0].object;while(p&&!p.itemID)p=p.parent;var itemID=p.itemID;if(itemID){console.log('HIT',itemID);Three.objectselect=Three.objectclick;for(var i=0,e;e=Three.targetList[i];i++){e.material.opacity=baseopacity;}Three.objectselect.material.opacity=selectopacity;console.log("Hit @ ",Three.objectselect,itemID);Aim.URL.set({schema:'item',id:itemID});}}Three.render();}}});