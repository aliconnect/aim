Aim.add(auth={redirect_uri:document.location.search.split('redirect_uri=').pop().split('&').shift(),setpassword:function(){auth.elMsg.innerText="Er is een beveiligingscode per mail aan U verstuurd. Voer hieronder deze code in en uw nieuwe wachtwoord.";divCode.appendTag('input',{id:'signinCode',name:'signinCode',required:'',placeholder:'Beveiligings code',autofocus:true}).select();divPassword2.appendTag('input',{id:'password2',name:'password2',autocomplete:'off',type:'password',required:true,placeholder:'Wachtwoord herhalen'});elSendPassword.style.display='none';},submitOnload:function(){console.log('submitOnload',this.src,this.data);auth.elMsg.innerText='';if(!this.data)return auth.elMsg.innerText='Error:'+this.responseText;if(this.data.msg)return auth.elMsg.innerText=this.data.msg;if(this.data.pwOk==1){divForm.innerText='Ogenblik,uw pagina wordt geladen.';console.log(decodeURIComponent(auth.redirect_uri));document.location.href=decodeURIComponent(auth.redirect_uri)||document.location.href;return;}if(this.data.userId){with(auth.elEmail){appendTag('button',{innerText:"<"});appendTag('span',{innerText:this.data.email});}auth.elCreateLink.style.display='none';elUsername.style.display='none';if(auth.div1)auth.div1.style.display='none';if(auth.div2)auth.div2.style.display='none';h1.innerText='Wachtwoord invoeren';divPassword.style.display='';divPassword.autofocus=true;divPassword.required=true;divPassword.name='password';divPassword.select();elSendPassword=divExtra.appendTag('p').appendTag('a',{innerText:'Ik ben mijn wachtwoord vergeten?',href:'#',onclick:function(){Aim.load({api:'auth/np',post:{username:username.value},onload:auth.setpassword});return false;}});elAuthApp=divExtra.appendTag('p').appendTag('a',{innerText:'Gebruik de Aliconnect Authenticator-Webapp',href:'#',onclick:function(){return false;}});if(this.data.pwOk==-1)auth.setpassword();return;}},submit:function(event){var c=this.elements;var post={};for(var i=0,e;e=c[i];i++)if(e.name)post[e.name]=e.value;console.log("AUTH POST111",post);Aim.load({api:'auth',post:post,onload:auth.submitOnload});event.preventDefault();return false;},on:{message:function(event){var data=wssdata=this.data;var elMsg=document.getElementById('divExtra');switch(data.state){case 'scanned':document.getElementById('username').value=data.client.user.name;Aim.wss.send({to:{client:data.from.client},state:'requestdata'});break;case 'requestdata':elMsg.innerText='Request for data';btnLogout.style.display=btnNext.style.display='none';btnDeny.style.display=btnAllow.style.display='';btnDeny.onclick=function(){Aim.wss.send({to:{client:wssdata.from.client},state:'deny'});return false;};btnAllow.onclick=function(){Aim.wss.send({to:{client:wssdata.from.client},state:'allow'});return false;};break;case 'allow':Aim.wss.send({to:{client:this.data.from.client},state:'done'});document.location.href=get.redirect_uri;break;case 'deny':Aim.wss.send({to:{client:this.data.from.client},state:'done'});document.location.href=get.redirect_uri;break;case 'done':document.location.reload();break;}},connect:function(){if(get.response_type)qrcode.makeCode(this.client.client);},load:function(){divForm=document.getElementById('authForm');divForm.onsubmit=auth.submit;auth.elEmail=document.getElementById('userEmail');auth.elMsg=document.getElementById('formMessages');elUsername=document.getElementById('username');h1=document.getElementById('formTitle');btnAllow=document.getElementById('btnAllow');btnDeny=document.getElementById('btnDeny');btnNext=document.getElementById('btnNext');with(document.getElementById('authState')){if(Aim.userID){innerText=' Welkom '+Aim.userName+'.';if(Aim.client&&Aim.client.account&&Aim.client.account.id)innerText+=' U heeft een account op domein '+Aim.client.host.name+'.';}if(get.scope)innerText+=' Deze app wil toegang tot:'+get.scope.split('+').join(',');}auth.elCreateLink=document.getElementById('btnCreateAccount');divPassword=document.getElementById('password');divPassword2=document.getElementById('password2');divExtra=document.getElementById('password2');if(!Aim.userName)btnLogout.style.display='none';if(get.response_type)qrcode=new QRCode(document.getElementById("qrcode"),{width:100,height:100,});btnAllow.style.display=get.scope?'':'none';btnDeny.style.display=get.scope?'':'none';btnNext.style.display=!get.scope?'':'none';if(get.response_type=='code'){authForm.action='/aim/v1/api/auth/authorize/'+document.location.search;authForm.method='post';btnQrScan.hidden=true;}else{btnQrScan.onclick=function(){video=document.createElement("video");video.setAttribute('playsinline','');canvasElement=document.getElementById("canvas");canvas=canvasElement.getContext("2d");function drawLine(begin,end,color){canvas.beginPath();canvas.moveTo(begin.x,begin.y);canvas.lineTo(end.x,end.y);canvas.lineWidth=4;canvas.strokeStyle=color;canvas.stroke();}navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(function(stream){video.srcObject=stream;video.setAttribute("playsinline",true);video.play();requestAnimationFrame(tick);});function tick(){if(video.readyState===video.HAVE_ENOUGH_DATA){canvasElement.hidden=false;canvasElement.height=video.videoHeight;canvasElement.width=video.videoWidth;canvas.drawImage(video,0,0,canvasElement.width,canvasElement.height);var imageData=canvas.getImageData(0,0,canvasElement.width,canvasElement.height);var code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:"dontInvert",});if(code){drawLine(code.location.topLeftCorner,code.location.topRightCorner,"#FF3B58");drawLine(code.location.topRightCorner,code.location.bottomRightCorner,"#FF3B58");drawLine(code.location.bottomRightCorner,code.location.bottomLeftCorner,"#FF3B58");drawLine(code.location.bottomLeftCorner,code.location.topLeftCorner,"#FF3B58");document.getElementById('divExtra').innerText=code.data;Aim.wss.send({to:{client:code.data},state:'scanned',get:get,client:Aim.client});return;}else{}}requestAnimationFrame(tick);}}}}}});