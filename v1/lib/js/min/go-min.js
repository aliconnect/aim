Aim.add({Go:{show:function(event){console.log('GRAPH.onload',this.el,this.data);var rows=this.data;this.data={items:{},links:[],}linecolors={Child:'blue',Derivative:'green',Subscribers:'yellow',Attribute:'orange',Link:'red',}rows.forEach(function(row){if(row.hidden)return;for(var toID in row.linkto){this.data.links.push({from:row.id,to:toID,color:linecolors[row.linkto[toID]]});var item=Aim.api.item[row.id];if(item)this.data.items[item.id]={item:item,key:item.id,text:item.title,color:item.id==get.id?'green':item.srcID==item.masterID?'yellow':item.backgroundColor}var item=Aim.api.item[toID];if(item)this.data.items[item.id]={item:item,key:item.id,text:item.title,color:item.id==get.id?'green':item.srcID==item.masterID?'yellow':item.backgroundColor}}}.bind(this));this.data.items=Object.values(this.data.items);console.log(this.data);with(OM.elDiagram=this.el){appendTag('div',{style:'display:block;position:absolute;background:#fff;top:9px;left:13px;width:164px;height:56px;z-index:3;'});with(appendTag('div',{className:'row top btnbar',style:'position:absolute;z-index:4;width:100%;background:rgba(0,0,0,0.5);'})){appendTag('button',{className:'abtn icn close r',onclick:function(){var p=this.parentElement.parentElement;p.parentElement.removeChild(p);},});}var elDiagram=appendTag('div',{className:'col aco',style:'background:white;height:100%;'}).appendTag('div',{style:"height:100%;width:100%;"});function init(){var $=go.GraphObject.make;myDiagram=$(go.Diagram,elDiagram,{initialAutoScale:go.Diagram.UniformToFill,padding:10,contentAlignment:go.Spot.Center,layout:$(go.ForceDirectedLayout,{defaultSpringLength:10}),maxSelectionCount:2});myDiagram.nodeTemplate=$(go.Node,"Horizontal",{locationSpot:go.Spot.Center,locationObjectName:"SHAPE",selectionAdorned:false,},$(go.Panel,"Auto",$(go.Shape,"Ellipse",{name:"SHAPE",fill:"lightgray",stroke:"transparent",strokeWidth:2,desiredSize:new go.Size(30,30),portId:""},new go.Binding("fill","isSelected",function(s,obj){return s?"red":obj.part.data.color;}).ofObject()),$(go.TextBlock,new go.Binding("text","distance",function(d){if(d===Infinity)return "INF";else return d | 0;}))),$(go.TextBlock,new go.Binding("text")));myDiagram.linkTemplate=$(go.Link,{selectable:false,curve:go.Link.Bezier,layerName:"Background"},$(go.Shape,{isPanelMain:true,stroke:null,strokeWidth:5},new go.Binding("stroke","isHighlighted",function(h){return h?"red":null;}).ofObject()),$(go.Shape,{isPanelMain:true,stroke:"black",strokeWidth:1},new go.Binding("stroke","color")),$(go.Shape,{toArrow:"Standard"}));myDiagram.toolManager.clickSelectingTool.standardMouseSelect=function(event){console.log('CLICK',event,this);var diagram=this.diagram;if(diagram===null||!diagram.allowSelect)return;var e=diagram.lastInput;var count=diagram.selection.count;var curobj=diagram.findPartAt(e.documentPoint,false);console.log('CLICK',event,this,e,count,curobj);if(curobj !==null){console.log('standardMouseSelect',curobj);Aim.URL.set({schema:curobj.Cg.item.schema,id:curobj.Cg.item.id});return;if(count<2){if(!curobj.isSelected){var part=curobj;if(part !==null)part.isSelected=true;}}else{if(!curobj.isSelected){var part=curobj;if(part !==null)diagram.select(part);}}}else if(e.left&&!(e.control||e.meta)&&!e.shift){diagram.clearSelection();}}myDiagram.model=new go.GraphLinksModel(this.data.items,this.data.links);}function findDistances(source){console.log('findDistances');var diagram=source.diagram;var distances=new go.Map(go.Node,"number");var nit=diagram.nodes;while(nit.next()){var n=nit.value;distances.add(n,Infinity);}distances.add(source,0);var seen=new go.Set(go.Node);seen.add(source);var finished=new go.Set(go.Node);while(seen.count>0){var least=leastNode(seen,distances);var leastdist=distances.getAttribute(least);seen.remove(least);finished.add(least);var it=least.findLinksOutOf();while(it.next()){var link=it.value;var neighbor=link.getOtherNode(least);if(finished.contains(neighbor))continue;var neighbordist=distances.getAttribute(neighbor);var dist=leastdist+1;if(dist<neighbordist){if(neighbordist===Infinity){seen.add(neighbor);}distances.add(neighbor,dist);}}}return distances;}function leastNode(coll,distances){var bestdist=Infinity;var bestnode=null;var it=coll.iterator;while(it.next()){var n=it.value;var dist=distances.getAttribute(n);if(dist<bestdist){bestdist=dist;bestnode=n;}}return bestnode;}function findShortestPath(begin,end){distances=findDistances(begin);var path=new go.List();path.add(end);while(end !==null){var next=leastNode(end.findNodesInto(),distances);if(next !==null){if(distances.getAttribute(next)<distances.getAttribute(end)){path.add(next);}else{next=null;}}end=next;}path.reverse();return path;}function collectAllPaths(begin,end){var stack=new go.List(go.Node);var coll=new go.List(go.List);function find(source,end){source.findNodesOutOf().each(function(n){if(n===source)return;if(n===end){var path=stack.copy();path.add(end);coll.add(path);}else if(!stack.contains(n)){stack.add(n);find(n,end);stack.removeAt(stack.count-1);}});}stack.add(begin);find(begin,end);return coll;}function pathToString(path){var s=path.length+":";for(var i=0;i<path.length;i++){if(i>0)s+="--";s+=path.elt(i).data.text;}return s;}function nodeSelectionchanged(node){console.log('changed');var diagram=node.diagram;if(diagram===null)return;diagram.clearHighlighteds();if(node.isSelected){console.log(node);OM.show({id:node.Pg.key});var begin=diagram.selection.first();showDistances(begin);if(diagram.selection.count===2){var end=node;highlightShortestPath(begin,end);}}}function showDistances(begin){distances=findDistances(begin);var it=distances.iterator;while(it.next()){var n=it.key;var dist=it.value;myDiagram.model.setDataProperty(n.data,"distance",dist);}}function highlightShortestPath(begin,end){highlightPath(findShortestPath(begin,end));}var paths=null;function highlightSelectedPath(){var sel=document.getElementById("myPaths");var idx=sel.selectedIndex;var opt=sel.options[idx];var val=opt.value;highlightPath(paths.elt(sel.selectedIndex));}function highlightPath(path){myDiagram.clearHighlighteds();for(var i=0;i<path.count-1;i++){var f=path.elt(i);var t=path.elt(i+1);f.findLinksTo(t).each(function(l){l.isHighlighted=true;});}}init.call(this);}},}});function findDistances(source){var diagram=source.diagram;var distances=new go.Map(go.Node,"number");var nit=diagram.nodes;while(nit.next()){var n=nit.value;distances.add(n,Infinity);}distances.add(source,0);var seen=new go.Set(go.Node);seen.add(source);var finished=new go.Set(go.Node);while(seen.count>0){var least=leastNode(seen,distances);var leastdist=distances.getAttribute(least);seen.remove(least);finished.add(least);var it=least.findLinksOutOf();while(it.next()){var link=it.value;var neighbor=link.getOtherNode(least);if(finished.contains(neighbor))continue;var neighbordist=distances.getAttribute(neighbor);var dist=leastdist+1;if(dist<neighbordist){if(neighbordist===Infinity){seen.add(neighbor);}distances.add(neighbor,dist);}}}return distances;}function leastNode(coll,distances){var bestdist=Infinity;var bestnode=null;var it=coll.iterator;while(it.next()){var n=it.value;var dist=distances.getAttribute(n);if(dist<bestdist){bestdist=dist;bestnode=n;}}return bestnode;}function findShortestPath(begin,end){distances=findDistances(begin);var path=new go.List();path.add(end);while(end !==null){var next=leastNode(end.findNodesInto(),distances);if(next !==null){if(distances.getAttribute(next)<distances.getAttribute(end)){path.add(next);}else{next=null;}}end=next;}path.reverse();return path;}function collectAllPaths(begin,end){var stack=new go.List(go.Node);var coll=new go.List(go.List);function find(source,end){source.findNodesOutOf().each(function(n){if(n===source)return;if(n===end){var path=stack.copy();path.add(end);coll.add(path);}else if(!stack.contains(n)){stack.add(n);find(n,end);stack.removeAt(stack.count-1);}});}stack.add(begin);find(begin,end);return coll;}function pathToString(path){var s=path.length+":";for(var i=0;i<path.length;i++){if(i>0)s+="--";s+=path.elt(i).data.text;}return s;}function nodeSelectionchanged(node){var diagram=node.diagram;if(diagram===null)return;diagram.clearHighlighteds();if(node.isSelected){console.log(node);OM.show({id:node.Pg.key});var begin=diagram.selection.first();showDistances(begin);if(diagram.selection.count===2){var end=node;highlightShortestPath(begin,end);}}}function showDistances(begin){distances=findDistances(begin);var it=distances.iterator;while(it.next()){var n=it.key;var dist=it.value;myDiagram.model.setDataProperty(n.data,"distance",dist);}}function highlightShortestPath(begin,end){highlightPath(findShortestPath(begin,end));}var paths=null;function highlightSelectedPath(){var sel=document.getElementById("myPaths");var idx=sel.selectedIndex;var opt=sel.options[idx];var val=opt.value;highlightPath(paths.elt(sel.selectedIndex));}function highlightPath(path){myDiagram.clearHighlighteds();for(var i=0;i<path.count-1;i++){var f=path.elt(i);var t=path.elt(i+1);f.findLinksTo(t).each(function(l){l.isHighlighted=true;});}}function initFlowchart(ele,obj,data){var $=go.GraphObject.make;with(ele){innerHTML='';with(addtag('div',{className:'diagramFlowchart row'},{style:"height:400px;width:100%;"})){with(addtag('div',{className:'diagram myPalette'},{style:"height:400px;"})){obj.myPaletteDiv=addtag('div',{},{style:"height:400px;"});obj.myPaletteDiv.id='myPalette';}with(addtag('div',{className:'diagram myDiagram row content'},{style:"height:400px;"})){obj.myDiagramDiv=addtag('div',{className:'content'},{style:"height:100%;"});obj.myDiagramDiv.id='myDiagram';}}}var myDiagram=$(go.Diagram,obj.myDiagramDiv,{initialContentAlignment:go.Spot.Center,allowDrop:true,"LinkDrawn":showLinkLabel,"LinkRelinked":showLinkLabel,"animationManager.duration":800,"undoManager.isEnabled":true});obj.myDiagram=myDiagram;obj.myDiagram.addDiagramListener("Modified",function(event){var button=om.panel.item.panel.diagramSaveButton;if(button)button.disabled=!myDiagram.isModified;});function nodeStyle(){return [new go.Binding("location","loc",go.Point.parse).makeTwoWay(go.Point.stringify),{locationSpot:go.Spot.Center,mouseEnter:function(e,obj){showPorts(obj.part,true);},mouseLeave:function(e,obj){showPorts(obj.part,false);}}];}function makePort(name,spot,output,input){return $(go.Shape,"Circle",{fill:"transparent",stroke:null,desiredSize:new go.Size(8,8),alignment:spot,alignmentFocus:spot,portId:name,fromSpot:spot,toSpot:spot,fromLinkable:output,toLinkable:input,cursor:"pointer"});}var lightText='whitesmoke';myDiagram.nodeTemplateMap.add("",$(go.Node,"Spot",nodeStyle(),$(go.Panel,"Auto",$(go.Shape,"Rectangle",{fill:"#00A9C9",stroke:null},new go.Binding("figure","figure")),$(go.TextBlock,{font:"bold 11pt Helvetica,Arial,sans-serif",stroke:lightText,margin:8,maxSize:new go.Size(160,NaN),wrap:go.TextBlock.WrapFit,editable:true},new go.Binding("text").makeTwoWay())),makePort("T",go.Spot.Top,false,true),makePort("L",go.Spot.Left,true,true),makePort("R",go.Spot.Right,true,true),makePort("B",go.Spot.Bottom,true,false)));myDiagram.nodeTemplateMap.add("Start",$(go.Node,"Spot",nodeStyle(),$(go.Panel,"Auto",$(go.Shape,"Circle",{minSize:new go.Size(40,40),fill:"#79C900",stroke:null}),$(go.TextBlock,"Start",{font:"bold 11pt Helvetica,Arial,sans-serif",stroke:lightText},new go.Binding("text"))),makePort("L",go.Spot.Left,true,false),makePort("R",go.Spot.Right,true,false),makePort("B",go.Spot.Bottom,true,false)));myDiagram.nodeTemplateMap.add("End",$(go.Node,"Spot",nodeStyle(),$(go.Panel,"Auto",$(go.Shape,"Circle",{minSize:new go.Size(40,40),fill:"#DC3C00",stroke:null}),$(go.TextBlock,"End",{font:"bold 11pt Helvetica,Arial,sans-serif",stroke:lightText},new go.Binding("text"))),makePort("T",go.Spot.Top,false,true),makePort("L",go.Spot.Left,false,true),makePort("R",go.Spot.Right,false,true)));myDiagram.nodeTemplateMap.add("Comment",$(go.Node,"Auto",nodeStyle(),$(go.Shape,"File",{fill:"#EFFAB4",stroke:null}),$(go.TextBlock,{margin:5,maxSize:new go.Size(200,NaN),wrap:go.TextBlock.WrapFit,textAlign:"center",editable:true,font:"bold 12pt Helvetica,Arial,sans-serif",stroke:'#454545'},new go.Binding("text").makeTwoWay())));myDiagram.linkTemplate=$(go.Link,{routing:go.Link.AvoidsNodes,curve:go.Link.JumpOver,corner:5,toShortLength:4,relinkableFrom:true,relinkableTo:true,reshapable:true,resegmentable:true,mouseEnter:function(e,link){link.findObject("HIGHLIGHT").stroke="rgba(30,144,255,0.2)";},mouseLeave:function(e,link){link.findObject("HIGHLIGHT").stroke="transparent";}},new go.Binding("points").makeTwoWay(),$(go.Shape,{isPanelMain:true,strokeWidth:8,stroke:"transparent",name:"HIGHLIGHT"}),$(go.Shape,{isPanelMain:true,stroke:"gray",strokeWidth:2}),$(go.Shape,{toArrow:"standard",stroke:null,fill:"gray"}),$(go.Panel,"Auto",{visible:false,name:"LABEL",segmentIndex:2,segmentFraction:0.5},new go.Binding("visible","visible").makeTwoWay(),$(go.Shape,"RoundedRectangle",{fill:"#F8F8F8",stroke:null}),$(go.TextBlock,"Yes",{textAlign:"center",font:"10pt helvetica,arial,sans-serif",stroke:"#333333",editable:true},new go.Binding("text","text").makeTwoWay())));function showLinkLabel(e){var label=e.subject.findObject("LABEL");if(label !==null)label.visible=(e.subject.fromNode.data.figure==="Diamond");}myDiagram.toolManager.linkingTool.temporaryLink.routing=go.Link.Orthogonal;myDiagram.toolManager.relinkingTool.temporaryLink.routing=go.Link.Orthogonal;var JSONdata={nodeKeyProperty:"id",class:"go.GraphLinksModel",linkFromPortIdProperty:"fromPort",linkToPortIdProperty:"toPort"}if(data){if(data.nodeDataArray)JSONdata.nodeDataArray=data.nodeDataArray;if(data.linkDataArray)JSONdata.linkDataArray=data.linkDataArray;}myDiagram.model=go.Model.fromJson(JSON.stringify(JSONdata));myPalette=$(go.Palette,obj.myPaletteDiv,{"animationManager.duration":800,nodeTemplateMap:myDiagram.nodeTemplateMap,model:new go.GraphLinksModel([{category:"Start",text:"Start"},{category:"Start",text:"Start"},{text:"Step"},{text:"?",figure:"Diamond"},{category:"End",text:"End"},{category:"Comment",text:"Comment"}])});return obj.myDiagramDiv;}function showPorts(node,show){var diagram=node.diagram;if(!diagram||diagram.isReadOnly||!diagram.allowLink)return;node.ports.each(function(port){port.stroke=(show?"white":null);});}function diagramsave(){document.getElementById("mySavedModel").value=myDiagram.model.toJson();myDiagram.isModified=false;}function diagramload(){myDiagram.model=go.Model.fromJson(document.getElementById("mySavedModel").value);}function makeSVG(){var svg=myDiagram.makeSvg({scale:0.5});svg.style.border="1px solid black";obj=document.getElementById("SVGArea");obj.appendChild(svg);if(obj.children.length>0){obj.replaceChild(svg, obj.children[0]);}}